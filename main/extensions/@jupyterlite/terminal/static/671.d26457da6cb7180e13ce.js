/*! For license information please see 671.d26457da6cb7180e13ce.js.LICENSE.txt */
(()=>{var t={588:(t,e,n)=>{"use strict";var s,i,r;function*o(...t){for(const e of t)yield*e}function*a(){}function*l(t,e=0){for(const n of t)yield[e++,n]}function*c(t,e){let n=0;for(const s of t)e(s,n++)&&(yield s)}function h(t,e){let n=0;for(const s of t)if(e(s,n++))return s}function u(t,e){let n=0;for(const s of t)if(e(s,n++))return n-1;return-1}function d(t,e){let n;for(const s of t)void 0!==n?e(s,n)<0&&(n=s):n=s;return n}function m(t,e){let n;for(const s of t)void 0!==n?e(s,n)>0&&(n=s):n=s;return n}function f(t,e){let n,s,i=!0;for(const r of t)i?(n=r,s=r,i=!1):e(r,n)<0?n=r:e(r,s)>0&&(s=r);return i?void 0:[n,s]}function p(t){return Array.from(t)}function g(t){const e={};for(const[n,s]of t)e[n]=s;return e}function _(t,e){let n=0;for(const s of t)if(!1===e(s,n++))return}function w(t,e){let n=0;for(const s of t)if(!1===e(s,n++))return!1;return!0}function y(t,e){let n=0;for(const s of t)if(e(s,n++))return!0;return!1}function*C(t,e){let n=0;for(const s of t)yield e(s,n++)}function*v(t,e,n){void 0===e?(e=t,t=0,n=1):void 0===n&&(n=1);const s=i.rangeLength(t,e,n);for(let e=0;e<s;e++)yield t+n*e}function x(t,e,n){const s=t[Symbol.iterator]();let i=0,r=s.next();if(r.done&&void 0===n)throw new TypeError("Reduce of empty iterable with no initial value.");if(r.done)return n;let o,a,l=s.next();if(l.done&&void 0===n)return r.value;if(l.done)return e(n,r.value,i++);for(o=e(void 0===n?r.value:e(n,r.value,i++),l.value,i++);!(a=s.next()).done;)o=e(o,a.value,i++);return o}function*b(t,e){for(;0<e--;)yield t}function*S(t){yield t}function*E(t){if("function"==typeof t.retro)yield*t.retro();else for(let e=t.length-1;e>-1;e--)yield t[e]}function O(t){let e=[],n=new Set,s=new Map;for(const e of t)i(e);for(const[t]of s)r(t);return e;function i(t){let[e,n]=t,i=s.get(n);i?i.push(e):s.set(n,[e])}function r(t){if(n.has(t))return;n.add(t);let i=s.get(t);if(i)for(const t of i)r(t);e.push(t)}}function*I(t,e){let n=0;for(const s of t)0===n++%e&&(yield s)}function*k(t,e){if(e<1)return;const n=t[Symbol.iterator]();let s;for(;0<e--&&!(s=n.next()).done;)yield s.value}function*N(...t){const e=t.map(t=>t[Symbol.iterator]());let n=e.map(t=>t.next());for(;w(n,t=>!t.done);n=e.map(t=>t.next()))yield n.map(t=>t.value)}n.r(e),n.d(e,{ArrayExt:()=>s,StringExt:()=>r,chain:()=>o,each:()=>_,empty:()=>a,enumerate:()=>l,every:()=>w,filter:()=>c,find:()=>h,findIndex:()=>u,map:()=>C,max:()=>m,min:()=>d,minmax:()=>f,once:()=>S,range:()=>v,reduce:()=>x,repeat:()=>b,retro:()=>E,some:()=>y,stride:()=>I,take:()=>k,toArray:()=>p,toObject:()=>g,topologicSort:()=>O,zip:()=>N}),function(t){function e(t,e,n=0,s=-1){let i,r=t.length;if(0===r)return-1;n=n<0?Math.max(0,n+r):Math.min(n,r-1),i=(s=s<0?Math.max(0,s+r):Math.min(s,r-1))<n?s+1+(r-n):s-n+1;for(let s=0;s<i;++s){let i=(n+s)%r;if(t[i]===e)return i}return-1}function n(t,e,n=-1,s=0){let i,r=t.length;if(0===r)return-1;i=(n=n<0?Math.max(0,n+r):Math.min(n,r-1))<(s=s<0?Math.max(0,s+r):Math.min(s,r-1))?n+1+(r-s):n-s+1;for(let s=0;s<i;++s){let i=(n-s+r)%r;if(t[i]===e)return i}return-1}function s(t,e,n=0,s=-1){let i,r=t.length;if(0===r)return-1;n=n<0?Math.max(0,n+r):Math.min(n,r-1),i=(s=s<0?Math.max(0,s+r):Math.min(s,r-1))<n?s+1+(r-n):s-n+1;for(let s=0;s<i;++s){let i=(n+s)%r;if(e(t[i],i))return i}return-1}function i(t,e,n=-1,s=0){let i,r=t.length;if(0===r)return-1;i=(n=n<0?Math.max(0,n+r):Math.min(n,r-1))<(s=s<0?Math.max(0,s+r):Math.min(s,r-1))?n+1+(r-s):n-s+1;for(let s=0;s<i;++s){let i=(n-s+r)%r;if(e(t[i],i))return i}return-1}function r(t,e=0,n=-1){let s=t.length;if(!(s<=1))for(e=e<0?Math.max(0,e+s):Math.min(e,s-1),n=n<0?Math.max(0,n+s):Math.min(n,s-1);e<n;){let s=t[e],i=t[n];t[e++]=i,t[n--]=s}}function o(t,e){let n=t.length;if(e<0&&(e+=n),e<0||e>=n)return;let s=t[e];for(let s=e+1;s<n;++s)t[s-1]=t[s];return t.length=n-1,s}t.firstIndexOf=e,t.lastIndexOf=n,t.findFirstIndex=s,t.findLastIndex=i,t.findFirstValue=function(t,e,n=0,i=-1){let r=s(t,e,n,i);return-1!==r?t[r]:void 0},t.findLastValue=function(t,e,n=-1,s=0){let r=i(t,e,n,s);return-1!==r?t[r]:void 0},t.lowerBound=function(t,e,n,s=0,i=-1){let r=t.length;if(0===r)return 0;let o=s=s<0?Math.max(0,s+r):Math.min(s,r-1),a=(i=i<0?Math.max(0,i+r):Math.min(i,r-1))-s+1;for(;a>0;){let s=a>>1,i=o+s;n(t[i],e)<0?(o=i+1,a-=s+1):a=s}return o},t.upperBound=function(t,e,n,s=0,i=-1){let r=t.length;if(0===r)return 0;let o=s=s<0?Math.max(0,s+r):Math.min(s,r-1),a=(i=i<0?Math.max(0,i+r):Math.min(i,r-1))-s+1;for(;a>0;){let s=a>>1,i=o+s;n(t[i],e)>0?a=s:(o=i+1,a-=s+1)}return o},t.shallowEqual=function(t,e,n){if(t===e)return!0;if(t.length!==e.length)return!1;for(let s=0,i=t.length;s<i;++s)if(n?!n(t[s],e[s]):t[s]!==e[s])return!1;return!0},t.slice=function(t,e={}){let{start:n,stop:s,step:i}=e;if(void 0===i&&(i=1),0===i)throw new Error("Slice `step` cannot be zero.");let r,o=t.length;void 0===n?n=i<0?o-1:0:n<0?n=Math.max(n+o,i<0?-1:0):n>=o&&(n=i<0?o-1:o),void 0===s?s=i<0?-1:o:s<0?s=Math.max(s+o,i<0?-1:0):s>=o&&(s=i<0?o-1:o),r=i<0&&s>=n||i>0&&n>=s?0:i<0?Math.floor((s-n+1)/i+1):Math.floor((s-n-1)/i+1);let a=[];for(let e=0;e<r;++e)a[e]=t[n+e*i];return a},t.move=function(t,e,n){let s=t.length;if(s<=1)return;if((e=e<0?Math.max(0,e+s):Math.min(e,s-1))===(n=n<0?Math.max(0,n+s):Math.min(n,s-1)))return;let i=t[e],r=e<n?1:-1;for(let s=e;s!==n;s+=r)t[s]=t[s+r];t[n]=i},t.reverse=r,t.rotate=function(t,e,n=0,s=-1){let i=t.length;if(i<=1)return;if((n=n<0?Math.max(0,n+i):Math.min(n,i-1))>=(s=s<0?Math.max(0,s+i):Math.min(s,i-1)))return;let o=s-n+1;if(e>0?e%=o:e<0&&(e=(e%o+o)%o),0===e)return;let a=n+e;r(t,n,a-1),r(t,a,s),r(t,n,s)},t.fill=function(t,e,n=0,s=-1){let i,r=t.length;if(0!==r){n=n<0?Math.max(0,n+r):Math.min(n,r-1),i=(s=s<0?Math.max(0,s+r):Math.min(s,r-1))<n?s+1+(r-n):s-n+1;for(let s=0;s<i;++s)t[(n+s)%r]=e}},t.insert=function(t,e,n){let s=t.length;e=e<0?Math.max(0,e+s):Math.min(e,s);for(let n=s;n>e;--n)t[n]=t[n-1];t[e]=n},t.removeAt=o,t.removeFirstOf=function(t,n,s=0,i=-1){let r=e(t,n,s,i);return-1!==r&&o(t,r),r},t.removeLastOf=function(t,e,s=-1,i=0){let r=n(t,e,s,i);return-1!==r&&o(t,r),r},t.removeAllOf=function(t,e,n=0,s=-1){let i=t.length;if(0===i)return 0;n=n<0?Math.max(0,n+i):Math.min(n,i-1),s=s<0?Math.max(0,s+i):Math.min(s,i-1);let r=0;for(let o=0;o<i;++o)n<=s&&o>=n&&o<=s&&t[o]===e||s<n&&(o<=s||o>=n)&&t[o]===e?r++:r>0&&(t[o-r]=t[o]);return r>0&&(t.length=i-r),r},t.removeFirstWhere=function(t,e,n=0,i=-1){let r,a=s(t,e,n,i);return-1!==a&&(r=o(t,a)),{index:a,value:r}},t.removeLastWhere=function(t,e,n=-1,s=0){let r,a=i(t,e,n,s);return-1!==a&&(r=o(t,a)),{index:a,value:r}},t.removeAllWhere=function(t,e,n=0,s=-1){let i=t.length;if(0===i)return 0;n=n<0?Math.max(0,n+i):Math.min(n,i-1),s=s<0?Math.max(0,s+i):Math.min(s,i-1);let r=0;for(let o=0;o<i;++o)n<=s&&o>=n&&o<=s&&e(t[o],o)||s<n&&(o<=s||o>=n)&&e(t[o],o)?r++:r>0&&(t[o-r]=t[o]);return r>0&&(t.length=i-r),r}}(s||(s={})),function(t){t.rangeLength=function(t,e,n){return 0===n?1/0:t>e&&n>0||t<e&&n<0?0:Math.ceil((e-t)/n)}}(i||(i={})),function(t){function e(t,e,n=0){let s=new Array(e.length);for(let i=0,r=n,o=e.length;i<o;++i,++r){if(r=t.indexOf(e[i],r),-1===r)return null;s[i]=r}return s}t.findIndices=e,t.matchSumOfSquares=function(t,n,s=0){let i=e(t,n,s);if(!i)return null;let r=0;for(let t=0,e=i.length;t<e;++t){let e=i[t]-s;r+=e*e}return{score:r,indices:i}},t.matchSumOfDeltas=function(t,n,s=0){let i=e(t,n,s);if(!i)return null;let r=0,o=s-1;for(let t=0,e=i.length;t<e;++t){let e=i[t];r+=e-o-1,o=e}return{score:r,indices:i}},t.highlight=function(t,e,n){let s=[],i=0,r=0,o=e.length;for(;i<o;){let a=e[i],l=e[i];for(;++i<o&&e[i]===l+1;)l++;r<a&&s.push(t.slice(r,a)),a<l+1&&s.push(n(t.slice(a,l+1))),r=l+1}return r<t.length&&s.push(t.slice(r)),s},t.cmp=function(t,e){return t<e?-1:t>e?1:0}}(r||(r={}))},899:function(t,e,n){!function(t,e){"use strict";t.JSONExt=void 0,function(t){function e(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t}function n(t){return Array.isArray(t)}function s(t,i){if(t===i)return!0;if(e(t)||e(i))return!1;let r=n(t),o=n(i);return r===o&&(r&&o?function(t,e){if(t===e)return!0;if(t.length!==e.length)return!1;for(let n=0,i=t.length;n<i;++n)if(!s(t[n],e[n]))return!1;return!0}(t,i):function(t,e){if(t===e)return!0;for(let n in t)if(void 0!==t[n]&&!(n in e))return!1;for(let n in e)if(void 0!==e[n]&&!(n in t))return!1;for(let n in t){let i=t[n],r=e[n];if(void 0!==i||void 0!==r){if(void 0===i||void 0===r)return!1;if(!s(i,r))return!1}}return!0}(t,i))}function i(t){return e(t)?t:n(t)?function(t){let e=new Array(t.length);for(let n=0,s=t.length;n<s;++n)e[n]=i(t[n]);return e}(t):function(t){let e={};for(let n in t){let s=t[n];void 0!==s&&(e[n]=i(s))}return e}(t)}t.emptyObject=Object.freeze({}),t.emptyArray=Object.freeze([]),t.isPrimitive=e,t.isArray=n,t.isObject=function(t){return!e(t)&&!n(t)},t.deepEqual=s,t.deepCopy=i}(t.JSONExt||(t.JSONExt={}));var n;!function(t){class n{constructor(t){var e,n,s,i;this._activated=!1,this._promise=null,this._service=null,this.id=t.id,this.description=null!==(e=t.description)&&void 0!==e?e:"",this.activate=t.activate,this.deactivate=null!==(n=t.deactivate)&&void 0!==n?n:null,this.provides=null!==(s=t.provides)&&void 0!==s?s:null,this.autoStart=null!==(i=t.autoStart)&&void 0!==i&&i,this.requires=t.requires?t.requires.slice():[],this.optional=t.optional?t.optional.slice():[]}get activated(){return this._activated}set activated(t){this._activated=t}get service(){return this._service}set service(t){this._service=t}get promise(){return this._promise}set promise(t){this._promise=t}}t.createPluginData=function(t){return new n(t)},t.ensureNoCycle=function(t,e,n){const s=[...t.requires,...t.optional],i=s=>{if(s===t.provides)return!0;const o=n.get(s);if(!o)return!1;const a=e.get(o),l=[...a.requires,...a.optional];return 0!==l.length&&(r.push(o),!!l.some(i)||(r.pop(),!1))};if(!t.provides||0===s.length)return;const r=[t.id];if(s.some(i))throw new ReferenceError(`Cycle detected: ${r.join(" -> ")}.`)},t.findDependents=function(t,n,s){const i=new Array,r=t=>{const e=n.get(t),r=[...e.requires,...e.optional];i.push(...r.reduce((e,n)=>{const i=s.get(n);return i&&e.push([t,i]),e},[]))};for(const t of n.keys())r(t);const o=i.filter(e=>e[1]===t);let a=0;for(;o.length>a;){const t=o.length,e=new Set(o.map(t=>t[0]));for(const t of e)i.filter(e=>e[1]===t).forEach(t=>{o.includes(t)||o.push(t)});a=t}const l=e.topologicSort(o),c=l.findIndex(e=>e===t);return-1===c?[t]:l.slice(0,c+1)},t.collectStartupPlugins=function(t,e){const n=new Set;for(const e of t.keys())!0===t.get(e).autoStart&&n.add(e);if(e.startPlugins)for(const t of e.startPlugins)n.add(t);if(e.ignorePlugins)for(const t of e.ignorePlugins)n.delete(t);return Array.from(n)}}(n||(n={}));function s(t){let e=0;for(let n=0,s=t.length;n<s;++n)n%4==0&&(e=4294967295*Math.random()>>>0),t[n]=255&e,e>>>=8}t.Random=void 0,(t.Random||(t.Random={})).getRandomValues=(()=>{const t="undefined"!=typeof window&&(window.crypto||window.msCrypto)||null;return t&&"function"==typeof t.getRandomValues?function(e){return t.getRandomValues(e)}:s})(),t.UUID=void 0,(t.UUID||(t.UUID={})).uuid4=function(t){const e=new Uint8Array(16),n=new Array(256);for(let t=0;t<16;++t)n[t]="0"+t.toString(16);for(let t=16;t<256;++t)n[t]=t.toString(16);return function(){return t(e),e[6]=64|15&e[6],e[8]=128|63&e[8],n[e[0]]+n[e[1]]+n[e[2]]+n[e[3]]+"-"+n[e[4]]+n[e[5]]+"-"+n[e[6]]+n[e[7]]+"-"+n[e[8]]+n[e[9]]+"-"+n[e[10]]+n[e[11]]+n[e[12]]+n[e[13]]+n[e[14]]+n[e[15]]}}(t.Random.getRandomValues),t.MimeData=class{constructor(){this._types=[],this._values=[]}types(){return this._types.slice()}hasData(t){return-1!==this._types.indexOf(t)}getData(t){let e=this._types.indexOf(t);return-1!==e?this._values[e]:void 0}setData(t,e){this.clearData(t),this._types.push(t),this._values.push(e)}clearData(t){let e=this._types.indexOf(t);-1!==e&&(this._types.splice(e,1),this._values.splice(e,1))}clear(){this._types.length=0,this._values.length=0}},t.PluginRegistry=class{constructor(t={}){this._application=null,this._validatePlugin=()=>!0,this._plugins=new Map,this._services=new Map,t.validatePlugin&&(console.info("Plugins may be rejected by the custom validation plugin method."),this._validatePlugin=t.validatePlugin)}get application(){return this._application}set application(t){if(null!==this._application)throw Error("PluginRegistry.application is already set. It cannot be overridden.");this._application=t}get deferredPlugins(){return Array.from(this._plugins).filter(([t,e])=>"defer"===e.autoStart).map(([t,e])=>t)}getPluginDescription(t){var e,n;return null!==(n=null===(e=this._plugins.get(t))||void 0===e?void 0:e.description)&&void 0!==n?n:""}hasPlugin(t){return this._plugins.has(t)}isPluginActivated(t){var e,n;return null!==(n=null===(e=this._plugins.get(t))||void 0===e?void 0:e.activated)&&void 0!==n&&n}listPlugins(){return Array.from(this._plugins.keys())}registerPlugin(t){if(this._plugins.has(t.id))throw new TypeError(`Plugin '${t.id}' is already registered.`);if(!this._validatePlugin(t))throw new Error(`Plugin '${t.id}' is not valid.`);const e=n.createPluginData(t);n.ensureNoCycle(e,this._plugins,this._services),e.provides&&this._services.set(e.provides,e.id),this._plugins.set(e.id,e)}registerPlugins(t){for(const e of t)this.registerPlugin(e)}deregisterPlugin(t,e){const n=this._plugins.get(t);if(n){if(n.activated&&!e)throw new Error(`Plugin '${t}' is still active.`);this._plugins.delete(t)}}async activatePlugin(t){const e=this._plugins.get(t);if(!e)throw new ReferenceError(`Plugin '${t}' is not registered.`);if(e.activated)return;if(e.promise)return e.promise;const n=e.requires.map(t=>this.resolveRequiredService(t)),s=e.optional.map(t=>this.resolveOptionalService(t));return e.promise=Promise.all([...n,...s]).then(t=>e.activate.apply(void 0,[this.application,...t])).then(t=>{e.service=t,e.activated=!0,e.promise=null}).catch(t=>{throw e.promise=null,t}),e.promise}async activatePlugins(t,e={}){switch(t){case"defer":{const t=this.deferredPlugins.filter(t=>this._plugins.get(t).autoStart).map(t=>this.activatePlugin(t));await Promise.all(t);break}case"startUp":{const t=n.collectStartupPlugins(this._plugins,e).map(async t=>{try{return await this.activatePlugin(t)}catch(e){console.error(`Plugin '${t}' failed to activate.`,e)}});await Promise.all(t);break}}}async deactivatePlugin(t){const e=this._plugins.get(t);if(!e)throw new ReferenceError(`Plugin '${t}' is not registered.`);if(!e.activated)return[];if(!e.deactivate)throw new TypeError(`Plugin '${t}'#deactivate() method missing`);const s=n.findDependents(t,this._plugins,this._services),i=s.map(t=>this._plugins.get(t));for(const e of i)if(!e.deactivate)throw new TypeError(`Plugin ${e.id}#deactivate() method missing (depends on ${t})`);for(const t of i){const e=[...t.requires,...t.optional].map(t=>{const e=this._services.get(t);return e?this._plugins.get(e).service:null});await t.deactivate(this.application,...e),t.service=null,t.activated=!1}return s.pop(),s}async resolveRequiredService(t){const e=this._services.get(t);if(!e)throw new TypeError(`No provider for: ${t.name}.`);const n=this._plugins.get(e);return n.activated||await this.activatePlugin(e),n.service}async resolveOptionalService(t){const e=this._services.get(t);if(!e)return null;const n=this._plugins.get(e);if(!n.activated)try{await this.activatePlugin(e)}catch(t){return console.error(t),null}return n.service}},t.PromiseDelegate=class{constructor(){this.promise=new Promise((t,e)=>{this._resolve=t,this._reject=e})}resolve(t){(0,this._resolve)(t)}reject(t){(0,this._reject)(t)}},t.Token=class{constructor(t,e){this.name=t,this.description=null!=e?e:"",this._tokenStructuralPropertyT=null}}}(e,n(588))}},e={};function n(s){var i=e[s];if(void 0!==i)return i.exports;var r=e[s]={exports:{}};return t[s].call(r.exports,r,r.exports,n),r.exports}n.d=(t,e)=>{for(var s in e)n.o(e,s)&&!n.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";var t={};n.r(t),n.d(t,{AliasCommand:()=>Et,BuiltinCommand:()=>ct,CdCommand:()=>Rt,ClearCommand:()=>Mt,CockleConfigCommand:()=>Ut,ExitCommand:()=>$t,ExportCommand:()=>Vt,FalseCommand:()=>Tt,HelpCommand:()=>Qt,HistoryCommand:()=>Yt,TrueCommand:()=>Nt,WhichCommand:()=>Jt});const e=Symbol("Comlink.proxy"),s=Symbol("Comlink.endpoint"),i=Symbol("Comlink.releaseProxy"),r=Symbol("Comlink.finalizer"),o=Symbol("Comlink.thrown"),a=t=>"object"==typeof t&&null!==t||"function"==typeof t,l={canHandle:t=>a(t)&&t[e],serialize(t){const{port1:e,port2:n}=new MessageChannel;return h(t,e),[n,[n]]},deserialize:t=>(t.start(),function(t){const e=new Map;return t.addEventListener("message",function(t){const{data:n}=t;if(!n||!n.id)return;const s=e.get(n.id);if(s)try{s(n)}finally{e.delete(n.id)}}),g(t,e,[],void 0)}(t))},c=new Map([["proxy",l],["throw",{canHandle:t=>a(t)&&o in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function h(t,n=globalThis,s=["*"]){n.addEventListener("message",function i(a){if(!a||!a.data)return;if(!function(t,e){for(const n of t){if(e===n||"*"===n)return!0;if(n instanceof RegExp&&n.test(e))return!0}return!1}(s,a.origin))return void console.warn(`Invalid origin '${a.origin}' for comlink proxy`);const{id:l,type:c,path:d}=Object.assign({path:[]},a.data),m=(a.data.argumentList||[]).map(C);let f;try{const n=d.slice(0,-1).reduce((t,e)=>t[e],t),s=d.reduce((t,e)=>t[e],t);switch(c){case"GET":f=s;break;case"SET":n[d.slice(-1)[0]]=C(a.data.value),f=!0;break;case"APPLY":f=s.apply(n,m);break;case"CONSTRUCT":f=function(t){return Object.assign(t,{[e]:!0})}(new s(...m));break;case"ENDPOINT":{const{port1:e,port2:n}=new MessageChannel;h(t,n),f=function(t,e){return w.set(t,e),t}(e,[e])}break;case"RELEASE":f=void 0;break;default:return}}catch(t){f={value:t,[o]:0}}Promise.resolve(f).catch(t=>({value:t,[o]:0})).then(e=>{const[s,o]=y(e);n.postMessage(Object.assign(Object.assign({},s),{id:l}),o),"RELEASE"===c&&(n.removeEventListener("message",i),u(n),r in t&&"function"==typeof t[r]&&t[r]())}).catch(t=>{const[e,s]=y({value:new TypeError("Unserializable return value"),[o]:0});n.postMessage(Object.assign(Object.assign({},e),{id:l}),s)})}),n.start&&n.start()}function u(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function d(t){if(t)throw new Error("Proxy has been released and is not useable")}function m(t){return v(t,new Map,{type:"RELEASE"}).then(()=>{u(t)})}const f=new WeakMap,p="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(f.get(t)||0)-1;f.set(t,e),0===e&&m(t)});function g(t,e,n=[],r=function(){}){let o=!1;const a=new Proxy(r,{get(s,r){if(d(o),r===i)return()=>{!function(t){p&&p.unregister(t)}(a),m(t),e.clear(),o=!0};if("then"===r){if(0===n.length)return{then:()=>a};const s=v(t,e,{type:"GET",path:n.map(t=>t.toString())}).then(C);return s.then.bind(s)}return g(t,e,[...n,r])},set(s,i,r){d(o);const[a,l]=y(r);return v(t,e,{type:"SET",path:[...n,i].map(t=>t.toString()),value:a},l).then(C)},apply(i,r,a){d(o);const l=n[n.length-1];if(l===s)return v(t,e,{type:"ENDPOINT"}).then(C);if("bind"===l)return g(t,e,n.slice(0,-1));const[c,h]=_(a);return v(t,e,{type:"APPLY",path:n.map(t=>t.toString()),argumentList:c},h).then(C)},construct(s,i){d(o);const[r,a]=_(i);return v(t,e,{type:"CONSTRUCT",path:n.map(t=>t.toString()),argumentList:r},a).then(C)}});return function(t,e){const n=(f.get(e)||0)+1;f.set(e,n),p&&p.register(t,e,t)}(a,t),a}function _(t){const e=t.map(y);return[e.map(t=>t[0]),(n=e.map(t=>t[1]),Array.prototype.concat.apply([],n))];var n}const w=new WeakMap;function y(t){for(const[e,n]of c)if(n.canHandle(t)){const[s,i]=n.serialize(t);return[{type:"HANDLER",name:e,value:s},i]}return[{type:"RAW",value:t},w.get(t)||[]]}function C(t){switch(t.type){case"HANDLER":return c.get(t.name).deserialize(t.value);case"RAW":return t.value}}function v(t,e,n,s){return new Promise(i=>{const r=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");e.set(r,i),t.start&&t.start(),t.postMessage(Object.assign({id:r},n),s)})}function x(t){return t>=65&&t<=90||t>=97&&t<=122}function b(t,e){return`${t=t.replace(/\/+$/,"")}/${e=e.replace(/^\/+/,"")}`}function S(t){return t.replace(/\s+$/,"")}var E;!function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"}(E||(E={}));class O{browsingContextId;shellId;constructor(t,e,n){this.browsingContextId=e,this.shellId=n,this._url=b(t,"api/stdin/terminal")}getStdin(t){try{const{xhr:e,msg:n}=this._prepareStdinRequest(t,E.SYNC);return e.send(n),this._processStdinReply(e.responseText)}catch(t){return console.error(`Failed to request stdin via service worker: ${t}`),""}}async getStdinAsync(t,e=!1){try{const{xhr:n,msg:s}=this._prepareStdinRequest(t,E.ASYNC,e),i=new Promise((t,e)=>{n.onload=()=>t(n.responseText),n.onerror=()=>e("XHR error")});return n.send(s),this._processStdinReply(await i)}catch(t){return console.error(`Failed to request stdin via service worker: ${t}`),""}}_prepareStdinRequest(t,e,n=!1){const s=new XMLHttpRequest;s.open("POST",this._url,e===E.ASYNC);const i={shellId:this.shellId,timeoutMs:t};return n&&(i.test=!0),{xhr:s,msg:JSON.stringify({browsingContextId:this.browsingContextId,data:i})}}_processStdinReply(t){const e=JSON.parse(t);if("error"in e)throw new Error(e.error);if(void 0!==e.text)return e.text??"";throw new Error(`Invalid stdin response: ${e}`)}_url}var I=n(899);const k="[";const N="[?1049h",T="[?1049l",A=(t=1)=>t>0?k+t+"C":"",R=(t=1)=>t>0?k+t+"D":"",P="[H",M="[2J",L="[3J",D="[K",F="[1K",W="[1;0m",B="[1;31m",U="[1;32m",j="[0;91m",H="[0;94m",$="[0;95m",z="[0;31m",V="[0;32m",q="[0;33m";var Q,X,Y;!function(t){let e,n,s,i;!function(t){t[t.ISTRIP=32]="ISTRIP",t[t.INLCR=64]="INLCR",t[t.IGNCR=128]="IGNCR",t[t.ICRNL=256]="ICRNL",t[t.IUCLC=512]="IUCLC",t[t.IXON=1024]="IXON",t[t.IXANY=2048]="IXANY",t[t.IMAXBEL=8192]="IMAXBEL",t[t.IUTF8=16384]="IUTF8"}(e=t.InputFlag||(t.InputFlag={})),function(t){t[t.OPOST=1]="OPOST",t[t.OLCUC=2]="OLCUC",t[t.ONLCR=4]="ONLCR",t[t.OCRNL=8]="OCRNL",t[t.ONOCR=16]="ONOCR",t[t.ONLRET=32]="ONLRET",t[t.TABDLY=6144]="TABDLY"}(n=t.OutputFlag||(t.OutputFlag={})),function(t){t[t.ISIG=1]="ISIG",t[t.ICANON=2]="ICANON",t[t.ECHO=8]="ECHO",t[t.ECHOE=16]="ECHOE",t[t.ECHOK=32]="ECHOK",t[t.ECHONL=64]="ECHONL",t[t.NOFLSH=128]="NOFLSH",t[t.ECHOCTL=512]="ECHOCTL",t[t.ECHOPRT=1024]="ECHOPRT",t[t.ECHOKE=2048]="ECHOKE",t[t.IEXTEN=32768]="IEXTEN"}(s=t.LocalFlag||(t.LocalFlag={})),function(t){t[t.VINTR=0]="VINTR",t[t.VQUIT=1]="VQUIT",t[t.VERASE=2]="VERASE",t[t.VKILL=3]="VKILL",t[t.VEOF=4]="VEOF",t[t.VTIME=5]="VTIME",t[t.VMIN=6]="VMIN",t[t.VSWTCH=7]="VSWTCH",t[t.VSTART=8]="VSTART",t[t.VSTOP=9]="VSTOP",t[t.VSUSP=10]="VSUSP",t[t.VEOL=11]="VEOL",t[t.VREPRINT=12]="VREPRINT",t[t.VDISCARD=13]="VDISCARD",t[t.VWERASE=14]="VWERASE",t[t.VLNEXT=15]="VLNEXT",t[t.VEOL2=16]="VEOL2"}(i=t.ControlCharacter||(t.ControlCharacter={})),t.cloneFlags=function(t){return{c_iflag:t.c_iflag,c_oflag:t.c_oflag,c_cflag:t.c_cflag,c_lflag:t.c_lflag,c_cc:[...t.c_cc]}};class r{c_iflag=0;c_oflag=0;c_cflag=0;c_lflag=0;c_cc=[]}t.Flags=r,t.Termios=class{constructor(){this.setDefaultShell()}get(){return this._flags}log(t){const i=(t,e,n)=>{const s=[];for(const[e,i]of Object.entries(t).filter(([t,e])=>t[0].match(/\D/)))(n&i)>0&&s.push(e);return`  ${e} = ${n} 0x${n.toString(16)} = ${s.join(" ")}`},r=["Cockle "+t+":"],o=this._flags;r.push(i(e,"c_iflag",o.c_iflag)),r.push(i(n,"c_oflag",o.c_oflag)),r.push(`  c_cflag = ${o.c_cflag} 0x${o.c_cflag.toString(16)}`),r.push(i(s,"c_lflag",o.c_lflag)),r.push(`  c_cc = ${o.c_cc}`),console.debug(r.join("\n"))}set(t){this._flags=t,this.log("Termios set")}setDefaultShell(){this.setDefaultWasm(),this._flags.c_oflag|=n.ONOCR}setDefaultWasm(){const t=this._flags;t.c_iflag=e.IUTF8|e.IMAXBEL|e.IXON|e.ICRNL,t.c_oflag=n.OPOST|n.ONLCR,t.c_cflag=191,t.c_lflag=s.IEXTEN|s.ECHOKE|s.ECHOCTL|s.ECHOK|s.ECHOE|s.ECHO|s.ICANON|s.ISIG,t.c_cc=[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}setRawMode(){const t=this._flags;t.c_iflag&=~(e.ISTRIP|e.INLCR|e.IGNCR|e.ICRNL|e.IXON),t.c_oflag&=~n.OPOST,t.c_lflag&=~(s.ECHO|s.ECHONL|s.ICANON|s.ISIG|s.IEXTEN)}_flags=new r}}(Q||(Q={}));class G{outputCallback;termios;constructor(t,e){this.outputCallback=t,this.termios=e}async canEnable(){await(this._available?.promise)}async disable(){this._enabled&&(this._enabled=!1,this._available?.resolve())}async enable(){this._enabled=!0,this._available=new I.PromiseDelegate}get enabled(){return this._enabled}poll(t){if(!this._enabled)throw new Error("WorkerIO.poll when disabled");let e=this._readBuffer.length>0;if(!e&&0!==t){const n=this._getStdin(t);this._postRead(n),e=this._readBuffer.length>0}return 4|(e?1:0)}read(t){if(!this._enabled)throw new Error("WorkerIO.read when disabled");if(null!==t&&t<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(t);const e=this._getStdin(-1);return this._postRead(e),this._readFromBuffer(t)}async readAsync(t,e){if(!this._enabled)throw new Error("WorkerIO.readAsync when disabled");if(null!==t&&t<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(t);const n=await this._getStdinAsync(e);return this._postRead(n),this._readFromBuffer(t)}utf8ArrayToString(t){return void 0===this._utf8Decoder&&(this._utf8Decoder=new TextDecoder("utf8")),this._utf8Decoder.decode(t)}write(t){let e=[];e="string"==typeof t?this._processWriteChars(t.split("").map(t=>t.charCodeAt(0))):this._processWriteChars(t),this.outputCallback(String.fromCharCode(...e))}_maybeEchoToOutput(t){const e=this.termios.get(),n=(e.c_lflag&Q.LocalFlag.ECHO)>0,s=(e.c_lflag&Q.LocalFlag.ECHONL)>0;if(!n&&!s)return;const i=[];for(const e of t)switch(e){case 10:i.push(10);break;case 4:break;default:n&&i.push(e)}i.length>0&&this.write(i)}_postRead(t){const e=t.split("").map(t=>t.charCodeAt(0)),n=this._processReadChars(e);this._readBuffer.push(...n),this._maybeEchoToOutput(n)}_processReadChars(t){const e=this.termios.get(),n=[];for(const s of t)switch(s){case 13:0===(e.c_iflag&Q.InputFlag.IGNCR)&&((e.c_iflag&Q.InputFlag.ICRNL)>0?n.push(10):n.push(13));break;case 10:(e.c_iflag&Q.InputFlag.INLCR)>0?n.push(13):n.push(10);break;default:n.push(s)}return n}_processWriteChars(t){const e=this.termios.get(),{c_oflag:n}=e,s=[];for(let e=0;e<t.length;e++){const i=t[e];if(27===i){const n=t.at(e+1);if(91===n||93===n){const n=91===t[e+1],i=t.slice(e+2).findIndex(t=>n?x(t):7===t||27===t);if(i>=0){const n=t.slice(e,e+i+3);s.push(...n),e+=i+2;const r=String.fromCharCode(...n);this._inAlternativeBuffer?r===T&&(this._inAlternativeBuffer=!1):r===N?this._inAlternativeBuffer=!0:r===P&&(this._writeColumn=0);continue}}else if(void 0!==n){const n=t.slice(e,e+2);s.push(...n),e+=1;continue}}switch(i){case 10:if(0===this._writeColumn&&(n&Q.OutputFlag.ONOCR)>0)break;this._writeColumn=0,(n&Q.OutputFlag.ONLCR)>0?s.push(13,10):s.push(10);break;default:!this._inAlternativeBuffer&&i>=32&&this._writeColumn++,s.push(i)}}return s}_readFromBuffer(t){if(null===t){const t=this._readBuffer;return this._readBuffer=[],t}{const e=this._readBuffer.slice(0,t);return this._readBuffer.splice(0,e.length),e}}_available;_enabled=!1;_inAlternativeBuffer=!1;_utf8Decoder;_writeColumn=0;_readBuffer=[]}class J extends G{constructor(t,e,n,s,i){super(t,e),this._utils=new O(n,s,i)}_getStdin(t){return this._utils.getStdin(t)}async _getStdinAsync(t){return this._utils.getStdinAsync(t)}_utils}!function(t){t.REQUEST_INDEX=0,t.TIMEOUT_INDEX=1,t.LENGTH_INDEX=2,t.START_INDEX=3,t.NO_REQUEST_VALUE=0,t.REQUEST_VALUE=1,t.ABORT_VALUE=2,t.maxChars=64;const e=1e5;t.encodeTimeout=function(t){return t<0||t>=e?e:Math.round(t)},t.decodeTimeout=function(t){return t>=e?-1:t}}(X||(X={}));class K extends G{constructor(t,e,n){super(t,e);const s=X.maxChars+4;this._sharedArrayBuffer=n,this._intArray=new Int32Array(this._sharedArrayBuffer,0,s)}_getStdin(t){Atomics.load(this._intArray,X.REQUEST_INDEX)!==X.NO_REQUEST_VALUE&&console.error("SharedArrayBuffer stdin request already pending"),Atomics.store(this._intArray,X.REQUEST_INDEX,X.REQUEST_VALUE),Atomics.store(this._intArray,X.TIMEOUT_INDEX,X.encodeTimeout(t)),Atomics.notify(this._intArray,X.REQUEST_INDEX,1),Atomics.wait(this._intArray,X.REQUEST_INDEX,X.REQUEST_VALUE);const e=Atomics.load(this._intArray,X.LENGTH_INDEX);let n="";for(let t=0;t<e;t++)n+=String.fromCharCode(Atomics.load(this._intArray,X.START_INDEX+t));return n}async _getStdinAsync(t){Atomics.load(this._intArray,X.REQUEST_INDEX)!==X.NO_REQUEST_VALUE&&console.error("SharedArrayBuffer stdin request already pending"),Atomics.store(this._intArray,X.REQUEST_INDEX,X.REQUEST_VALUE),Atomics.store(this._intArray,X.TIMEOUT_INDEX,X.encodeTimeout(t)),Atomics.notify(this._intArray,X.REQUEST_INDEX,1);const{async:e,value:n}=Atomics.waitAsync(this._intArray,X.REQUEST_INDEX,X.REQUEST_VALUE);e&&await n;const s=Atomics.load(this._intArray,X.LENGTH_INDEX);let i="";for(let t=0;t<s;t++)i+=String.fromCharCode(Atomics.load(this._intArray,X.START_INDEX+t));return i}_intArray;_sharedArrayBuffer}class Z{setMainIO;setWorkerIO;constructor(t,e){this.setMainIO=t,this.setWorkerIO=e,this._map.set("sab",{longName:"shared array buffer",available:!1}),this._map.set("sw",{longName:"service worker",available:!1})}available(t){return this._getByShortName(t).available}get enabled(){return this._enabled}get shortNames(){return Array(...this._map.keys())}longName(t){return this._getByShortName(t).longName}setAvailable(t,e){this._getByShortName(t).available=e}setEnabled(t){if(this._map.has(t))return void this._enable(t);const e=Object.entries(this._map).find(([e,n])=>n.longName===t);if(void 0===e)throw new Error(`Unknown StdinContext name '${t}'`);this._enable(e[0])}_enable(t){if(t!==this._enabled){if(!this._getByShortName(t).available)throw new Error(`StdinContext '${t}' is not available`);this._enabled=t,this._initialised?(this.setWorkerIO(t),this.setMainIO(t)):this._initialised=!0}}_getByShortName(t){const e=this._map.get(t);if(void 0===e)throw new Error(`Unknown shortName '${t}' passed to StdinContext`);return e}_map=new Map;_enabled="";_initialised=!1}class tt extends Map{constructor(){super()}getRecursive(t){let e=this.get(t);for(;void 0!==e;){const n=e.split(" ")[0];if(n===t)break;const s=this.get(n);if(void 0===s)return e;e=s+e.slice(n.length),t=n}return e}match(t){return[...this.keys()].filter(e=>e.startsWith(t))}}class et{get(t,e){const n=this.key(t,e);return this._cache.get(n)??void 0}has(t,e){const n=this.key(t,e);return this._cache.has(n)}key(t,e){return[t,e].join("/")}set(t,e,n){const s=this.key(t,e);this._cache.set(s,n)}_cache=new Map}class nt{wasmBaseUrl;downloadModuleCallback;constructor(t,e){this.wasmBaseUrl=t,this.downloadModuleCallback=e}getJavaScriptModule(t,e){const n=this._getModule(t,e,!1);return void 0!==n?n:void 0}getWasmModule(t,e){const n=this._getModule(t,e,!0);return void 0!==n?n:void 0}_getModule(t,e,n){let s=this.cache.get(t,e);if(void 0===s){const i=this.cache.key(t,e)+".js",r=b(this.wasmBaseUrl,i);console.log(`Cockle loading ${n?"WebAssembly":"JavaScript"} module from ${r}`),this.downloadModuleCallback(t,e,!0);try{importScripts(r),s=self.Module}finally{this.downloadModuleCallback(t,e,!1)}void 0!==s&&this.cache.set(t,e,s)}return s}cache=new et}!function(t){t[t.None=0]="None",t[t.Unknown=1]="Unknown",t[t.Builtin=2]="Builtin",t[t.External=4]="External",t[t.JavaScript=8]="JavaScript",t[t.Wasm=16]="Wasm",t[t.All=31]="All"}(Y||(Y={}));class st extends Error{exitCode;constructor(t,e){super(e),this.exitCode=t}}class it extends st{constructor(t){super(127,`'${t}': command not found`)}}class rt extends st{constructor(t){super(127,`'${t}': cannot load command`)}}class ot extends st{constructor(t){super(1,t)}}class at extends st{constructor(t){super(126,`'${t}': cannot run command`)}}class lt{name;callExternalCommand;callExternalTabComplete;constructor(t,e,n){this.name=t,this.callExternalCommand=e,this.callExternalTabComplete=n}get commandType(){return Y.External}get moduleName(){return"<external>"}names(){return[this.name]}get packageName(){return""}async run(t){const{name:e,args:n,environment:s,stdin:i,stdout:r,stderr:o}=t;if(e!==this.name)throw new it(e);const{exitCode:a,environmentChanges:l}=await this.callExternalCommand(e,n,Object.fromEntries(s),i.isTerminal(),r.isTerminal(),o.isTerminal(),t.termios.get());return void 0!==l&&Object.entries(l).forEach(([t,e])=>{void 0===e?s.delete(t):s.set(t,e)}),a}async tabComplete(t){if(void 0!==this.callExternalTabComplete){const{name:e,args:n}=t;return await this.callExternalTabComplete(e,n)}return{}}}class ct{get commandType(){return Y.Builtin}get moduleName(){return"<builtin>"}get packageName(){return""}names(){return[this.name]}run(t){const{name:e}=t;if(e!==this.name)throw new it(e);return this._run(t)}}class ht{shortName;longName;description;constructor(t,e,n){if(this.shortName=t,this.longName=e,this.description=n,0!==t.length&&1!==t.length)throw new ot(`Argument shortName ${t} must be a string of length 1`);if(!(0===e.length||e.length>1))throw new ot(`Argument longName ${e} must be a string of length greater than 1`)}get isSet(){return this._isSet}parse(t,e){return this.set(),e}set(){this._isSet=!0}_isSet=!1}class ut extends ht{constructor(t,e,n){super(t,e,n)}}class dt extends ht{options;constructor(t={}){super("","",""),this.options=t;const{max:e,min:n}=t;if(void 0!==n){if(n<0)throw new ot("Negative min for positional arguments");if(void 0!==e&&e<n)throw new ot("max must be greater than min for positional arguments")}}get length(){return this._strings.length}parse(t,e){this._strings.push(t),this.set();for(const t of e){if(t.startsWith("-"))throw new ot("Cannot have named argument after positional arguments");this._strings.push(t)}return[]}get strings(){return this._strings}_strings=[]}class mt extends dt{options;constructor(t={}){super(t),this.options=t}}var ft,pt,gt,_t,wt;!function(t){t[t.TOP=0]="TOP",t[t.MIDDLE=1]="MIDDLE",t[t.BOTTOM=2]="BOTTOM"}(ft||(ft={})),function(t){t[t.LEFT=0]="LEFT",t[t.INNER=1]="INNER",t[t.RIGHT=2]="RIGHT"}(pt||(pt={}));class yt{options;constructor(t){this.options=t}addHeaderRow(t){this._headerRows.push(t),this._updateColumnWidths(t)}addRow(t){this._rows.push(t),this._updateColumnWidths(t)}static defaultColorByColumn(){return new Map([[1,H],[2,$],[3,V],[4,q]])}*lines(t="",e=""){const{sortByColumn:n}=this.options;if(void 0!==n){const t=(e,s,i)=>{const r=n[e];return s[r]<i[r]?-1:s[r]>i[r]?1:n.length>e+1?t(e+1,s,i):0};this._rows.sort((e,n)=>t(0,e,n))}const s=this._columnWidths.length,i=this.horizontalSpacer(ft.TOP);void 0!==i&&(yield t+S(i)+e);for(const n of this._headerRows){let i="";for(let t=0;t<s;t++){i+=this.verticalSpacer(0===t?pt.LEFT:pt.INNER);const e=n[t]??"";i+=e+" ".repeat(this._columnWidths[t]-e.length)}i+=this.verticalSpacer(pt.RIGHT),yield t+S(i)+e}if(this._headerRows.length>0){const n=this.horizontalSpacer(ft.MIDDLE);void 0!==n&&(yield t+S(n)+e)}for(const n of this._rows){let i="";for(let t=0;t<s;t++){i+=this.verticalSpacer(0===t?pt.LEFT:pt.INNER);const e=n[t]??"";if(e){const n=this.options.colorByColumn?.get(t);i+=void 0!==n?n+e+W:e}i+=" ".repeat(this._columnWidths[t]-e.length)}i+=this.verticalSpacer(pt.RIGHT),yield t+S(i)+e}const r=this.horizontalSpacer(ft.BOTTOM);void 0!==r&&(yield t+S(r)+e)}get rowCount(){return this._rows.length}write(t,e="",n="\n"){for(const s of this.lines(e,n))t.write(s)}_updateColumnWidths(t){const e=t.map(t=>t.length),n=Math.min(this._columnWidths.length,e.length);for(let t=0;t<n;t++)this._columnWidths[t]=Math.max(this._columnWidths[t],e[t]);e.length>n&&this._columnWidths.push(...e.slice(n))}_columnWidths=[];_headerRows=[];_rows=[]}class Ct extends yt{constructor(t={}){super(t);const e=t.spacerSize??2;this._spacer=" ".repeat(e),this._spacersAtEnds=t.spacersAtEnds??!1}horizontalSpacer(t){if(t===ft.MIDDLE){const t=this._columnWidths.reduce((t,e)=>t+e)+this._totalSeparatorSize();return"â”€".repeat(t)}}verticalSpacer(t){return t===pt.INNER||this._spacersAtEnds?this._spacer:""}_totalSeparatorSize(){let t=this._columnWidths.length-1;return this._spacersAtEnds&&(t+=2),t*this._spacer.length}_spacer;_spacersAtEnds}class vt extends yt{constructor(t={}){super(t)}horizontalSpacer(t){const e=(t=>{switch(t){case ft.TOP:return"â•­â”¬â•®";case ft.MIDDLE:return"â”œâ”¼â”¤";case ft.BOTTOM:return"â•°â”´â•¯"}})(t);return e[0]+this._columnWidths.map(t=>"â”€".repeat(t+2)).join(e[1])+e[2]}verticalSpacer(t){return t===pt.LEFT?"â”‚ ":t===pt.RIGHT?" â”‚":" â”‚ "}}!function(t){t[t.Any=0]="Any",t[t.Directory=1]="Directory",t[t.File=2]="File"}(gt||(gt={}));class xt{parse(t){return this._parseToRun(t.slice()),this}async tabComplete(t){const e={...t,args:t.args.slice()},n=await this._parseToTabComplete(e);return n.possibles&&(n.possibles=n.possibles.filter(e=>e.startsWith(t.args.at(-1)))),n}writeHelp(t){for(const e of this._help())t.write(`${e}\n`)}_findByLongName(t){const e=this._longNameArguments;if(t in e)return e[t];throw new ot(`No such longName argument '${t}'`)}_findByShortName(t){const e=this._shortNameArguments;if(t in e)return e[t];throw new ot(`No such shortName argument '${t}'`)}*_help(){this.description&&(yield this.description);const t=new Ct({spacerSize:3});for(const e of Object.values(this))if(e instanceof ht){const{longName:n,shortName:s}=e;if(n||s){let i=s?`-${s}`:"  ";n&&(i+=(s?", ":"  ")+`--${n}`),t.addRow([i,e.description])}}if(t.rowCount>0&&(yield"",yield"options:",yield*t.lines("    ")),void 0!==this.subcommands){const t=new Ct({spacerSize:3});for(const e of Object.values(this.subcommands))t.addRow([e.name,e.description]);t.rowCount>0&&(yield"",yield"subcommands:",yield*t.lines("    "))}}get _longNameArguments(){const t=Object.values(this).filter(t=>t instanceof ht&&"longName"in t&&t.longName.length>0);return Object.fromEntries(t.map(t=>[t.longName,t]))}_parseToRun(t){const{positional:e}=this;let n=!1;const s=this.subcommands??{};let i=!0;for(;t.length>0;){const r=t.shift();if(i&&r in s){const e=s[r];e.set(),e.parse(t);break}if(r.startsWith("-")&&r.length>1){if(n)throw new ot("Cannot have named argument after positional arguments");if(r.startsWith("--")){const e=r.slice(2);t=this._findByLongName(e).parse(r,t)}else for(const e of r.slice(1).split(""))t=this._findByShortName(e).parse(r,t)}else{if(void 0===e)throw new ot(`Unrecognised argument: '${r}'`);n=!0,t=e.parse(r,t)}i=!1}if(void 0!==e){const{min:t,max:n}=e.options;if(void 0!==t&&e.length<t)throw new ot("Insufficient positional arguments");if(void 0!==n&&e.length>n)throw new ot("Too many positional arguments")}}async _parseToTabComplete(t){let{args:e}=t;const{positional:n}=this,s=this.subcommands??{};let i=!0;for(;e.length>0;){const r=e.shift(),o=0===e.length;if(i&&s){if(o){const t=Object.keys(s).filter(t=>t.startsWith(r));if(t.length>0)return{possibles:t}}if(r in s){const e=s[r];return e.set(),await e.tabComplete(t)}}if(r.startsWith("-")){if(o){const t=Object.keys(this._longNameArguments).map(t=>"--"+t);return r.startsWith("--")?{possibles:t}:r.length>2?{}:{possibles:Object.keys(this._shortNameArguments).map(t=>"-"+t).concat(t)}}if(r.startsWith("--")){const t=r.slice(2);e=this._findByLongName(t).parse(r,e)}else for(const t of r.slice(1).split(""))e=this._findByShortName(t).parse(r,e)}else if(void 0!==n){if(n instanceof mt)return{pathType:n.options.pathType??gt.Any};{const s=n.options.tabComplete;if(void 0!==s)return await s({...t,args:[r,...e]})}}i=!1}return{}}get _shortNameArguments(){const t=Object.values(this).filter(t=>t instanceof ht&&"shortName"in t&&t.shortName.length>0);return Object.fromEntries(t.map(t=>[t.shortName,t]))}positional;subcommands;description}class bt extends xt{name;description;constructor(t,e){super(),this.name=t,this.description=e}get isSet(){return this._isSet}set(){this._isSet=!0}_isSet=!1}class St extends xt{description="Without arguments, 'alias' prints the list of aliases in the reusable\n    form 'alias NAME=VALUE' on standard output.\n\n    Otherwise, an alias is defined for each NAME whose VALUE is given.\n    A trailing space in VALUE causes the next word to be checked for\n    alias substitution when the alias is expanded.";positional=new dt;help=new ut("h","help","display this help and exit")}class Et extends ct{get name(){return"alias"}async tabComplete(t){return await(new St).tabComplete(t)}async _run(t){const{aliases:e,stdout:n}=t,s=(new St).parse(t.args);if(s.help.isSet)return s.writeHelp(n),0;if(s.positional.isSet)for(const t of s.positional.strings){const s=t.indexOf("=");-1===s?n.write(`${t}='${e.get(t)}'\n`):e.set(t.slice(0,s),t.slice(s+1))}else for(const[t,s]of e.entries())n.write(`${t}='${s}'\n`);return 0}}class Ot extends xt{help=new ut("h","help","display this help and exit")}class It extends Ot{description="Always succeeds; Return a successful result."}class kt extends Ot{description="Always fails; Return an unsuccessful result."}class Nt extends ct{get name(){return"true"}async tabComplete(t){return await(new It).tabComplete(t)}async _run(t){const e=(new It).parse(t.args);return e.help.isSet?(e.writeHelp(t.stdout),0):0}}class Tt extends ct{get name(){return"false"}async tabComplete(t){return await(new kt).tabComplete(t)}async _run(t){const e=(new kt).parse(t.args);return e.help.isSet?(e.writeHelp(t.stdout),0):1}}class At extends xt{description='Change the shell working directory.\n  \n  Change the current directory to DIR. If DIR is "-", it is converted to $OLDPWD.';positional=new mt({pathType:gt.Directory});help=new ut("h","help","display this help and exit")}class Rt extends ct{get name(){return"cd"}async tabComplete(t){return await(new At).tabComplete(t)}async _run(t){const e=(new At).parse(t.args);if(e.help.isSet)return e.writeHelp(t.stdout),0;const n=e.positional.strings;if(n.length<1)return 0;if(n.length>1)throw new ot("cd: too many arguments");let s=n[0];if("-"===s){const e=t.environment.get("OLDPWD");if(void 0===e)throw new ot("cd: OLDPWD not set");s=e,t.stdout.write(`${s}\n`)}const{FS:i}=t.fileSystem,r=i.cwd();return i.chdir(s),t.environment.set("OLDPWD",r),t.environment.set("PWD",i.cwd()),0}}class Pt extends xt{description="Clear the terminal screen if ANSI escapes are supported.";help=new ut("h","help","display this help and exit")}class Mt extends ct{get name(){return"clear"}async tabComplete(t){return await(new Pt).tabComplete(t)}async _run(t){const{stdout:e}=t,n=(new Pt).parse(t.args);return n.help.isSet?(n.writeHelp(e),0):(e.isTerminal()&&e.write(M+L+P),0)}}class Lt extends bt{help=new ut("h","help","display this help and exit");builtin=new ut("b","builtin","display only builtin commands");external=new ut("e","external","display only external commands");javascript=new ut("j","javascript","display only javascript commands");wasm=new ut("w","wasm","display only wasm commands");positional=new dt({tabComplete:async t=>({possibles:t.commandRegistry?.match(t.args.at(-1)||"",jt(this))??[]})})}class Dt extends bt{positional=new dt({tabComplete:async t=>({possibles:t.commandRegistry?.allModules().map(t=>t.name)??[]})})}class Ft extends bt{positional=new dt({tabComplete:async t=>({possibles:t.commandRegistry?[...t.commandRegistry.commandPackageMap.keys()]:[]})})}class Wt extends bt{positional=new dt({max:1,tabComplete:async t=>({possibles:t.stdinContext?.shortNames??[]})})}class Bt extends xt{description="Inspect and optionally modify Cockle configuration. Without arguments prints all sections. Use subcommands to target specific areas.";version=new ut("v","version","show cockle version");help=new ut("h","help","display this help and exit");subcommands={command:new Lt("command","Show information about one or more commands."),module:new Dt("module","Show information about one or more modules."),package:new Ft("package","Show information about one or more packages."),stdin:new Wt("stdin","Configure or show synchronous stdin settings.")}}class Ut extends ct{get name(){return"cockle-config"}async tabComplete(t){return await(new Bt).tabComplete(t)}async _run(t){const{environment:e,stdout:n}=t,s=(new Bt).parse(t.args),{subcommands:i}=s;if(s.help.isSet)return s.writeHelp(n),0;const r=n.isTerminal()&&e.color?vt.defaultColorByColumn():void 0,o=0===t.args.length;if((o||s.version.isSet)&&this._writeVersion(t),(o||i.stdin.isSet)&&this._writeOrSetSyncStdinConfig(t,r,i.stdin.positional.strings.at(0)),(o||i.package.isSet)&&this._writePackageConfig(t,r,i.package.positional.strings),(o||i.module.isSet)&&this._writeModuleConfig(t,r,i.module.positional.strings),i.command.isSet){const{command:e}=i;if(e.help.isSet)return e.writeHelp(n),0;this._writeCommandConfig(t,r,e)}return 0}_writeCommandConfig(t,e,n){const{commandRegistry:s,stdout:i}=t,r=n.positional.strings;let o=s.commandNames(jt(n));if(r.length>0){const t=r.filter(t=>!o.includes(t));if(t.length>0)throw new ot(`Unknown command(s): ${t.sort().join(" ")}`);o=r.sort()}const a=new vt({colorByColumn:e,sortByColumn:[0]});a.addHeaderRow(["command","module"]);for(const t of o){const e=s.get(t);if(null===e)throw new ot(`Unknown command '${t}'`);a.addRow([t,e.moduleName])}a.write(i)}_writeModuleConfig(t,e,n){const{commandRegistry:s,commandModuleCache:i,stdout:r}=t;let o=s.allModules();const a=o.map(t=>t.name);if(n.length>0){const t=n.filter(t=>!a.includes(t));if(t.length>0)throw new ot(`Unknown module(s): ${t.sort().join(" ")}`);o=o.filter(t=>n.includes(t.name))}const l=new vt({colorByColumn:e,sortByColumn:[0,1]});l.addHeaderRow(["module","package","cached"]);for(const t of o)l.addRow([t.name,t.packageName,i.has(t.packageName,t.name)?"yes":""]);l.write(r)}_writeOrSetSyncStdinConfig(t,e,n){const{stdinContext:s,stdout:i}=t;void 0!==n&&s.setEnabled(n);const r=new vt({colorByColumn:e});r.addHeaderRow(["synchronous stdin","short name","available","enabled"]);const{enabled:o,shortNames:a}=s;for(const t of a)r.addRow([s.longName(t),t,s.available(t)?"yes":"",o===t?"yes":""]);r.write(i)}_writePackageConfig(t,e,n){const{commandRegistry:s,stdout:i}=t;let r=[...s.commandPackageMap.keys()];if(n.length>0){const t=n.filter(t=>!r.includes(t));if(t.length>0)throw new ot(`Unknown package(s): ${t.sort().join(" ")}`);r=n.sort()}const o=new vt({colorByColumn:e,sortByColumn:[0]});o.addHeaderRow(["package","type","version","build string","source"]);for(const t of r){const e=s.commandPackageMap.get(t);o.addRow([e.name,e.wasm?"wasm":"js",e.version,e.build_string,e.channel])}o.write(i)}_writeVersion(t){const{stdout:e}=t;e.write("cockle 1.3.0\n")}}function jt(t){let e=Y.None;return t.builtin.isSet&&(e|=Y.Builtin),t.external.isSet&&(e|=Y.External),t.javascript.isSet&&(e|=Y.JavaScript),t.wasm.isSet&&(e|=Y.Wasm),e===Y.None&&(e=Y.All),e}class Ht extends xt{description="Exit the shell";help=new ut("h","help","display this help and exit")}class $t extends ct{get name(){return"exit"}async tabComplete(t){return await(new Ht).tabComplete(t)}async _run(t){const{stdout:e,terminate:n}=t,s=(new Ht).parse(t.args);return s.help.isSet?(s.writeHelp(e),0):(e.write("Terminating shell...\n"),e.flush(),n(),0)}}class zt extends xt{description="Set export attribute for shell variables.\n    \n    Marks each NAME for automatic export to the environment of subsequently\n    executed commands.  If VALUE is supplied, assign VALUE before exporting.";positional=new dt;help=new ut("h","help","display this help and exit")}class Vt extends ct{get name(){return"export"}async tabComplete(t){return await(new zt).tabComplete(t)}async _run(t){const{environment:e,stdout:n}=t,s=(new zt).parse(t.args);if(s.help.isSet)return s.writeHelp(n),0;if(s.positional.isSet)for(const t of s.positional.strings){const n=t.indexOf("=");if(n>0){const s=t.slice(0,n),i=t.slice(n+1);e.set(s,i)}}return 0}}class qt extends xt{description="Show help for built-in commands. With no arguments, lists available builtins. With names, shows each command's help (equivalent to '<cmd> --help').";help=new ut("h","help","display this help and exit");positional=new dt({tabComplete:async t=>({possibles:t.commandRegistry?.commandNames(Y.Builtin)??[]})})}class Qt extends ct{get name(){return"help"}async tabComplete(t){return await(new qt).tabComplete(t)}async _run(t){const{args:e,stdout:n,stderr:s,commandRegistry:i}=t,r=(new qt).parse(e);if(r.help.isSet)return r.writeHelp(n),0;const o=r.positional.strings,a=i?i.commandNames(Y.Builtin):[];if(0===o.length){n.write("Built-in commands:\n");for(const t of a)n.write(`  ${t}\n`);return n.write("\n"),n.write("For detailed help, type <command-name> --help (e.g., `history --help` or `alias -h`)."),0}let l=0;for(const e of o){if(!a.includes(e)){s.write(`help: unknown built-in: ${e}\n`),l=1;continue}const r=i.get(e);if(null===r){s.write(`help: failed to get command '${e}'\n`),l=1;continue}const o={...t,name:e,args:["--help"]};n.write(`\n=== help for ${e} ===\n`),await r.run(o)}return l}}class Xt extends xt{description=" Display or manipulate the history list.\n\n    Display the history list with line numbers, prefixing each modified\n    entry with a '*'";clear=new ut("c","","clear the history by deleting all of the entries");help=new ut("h","help","display this help and exit")}class Yt extends ct{get name(){return"history"}async tabComplete(t){return await(new Xt).tabComplete(t)}async _run(t){const{history:e,stdout:n}=t,s=(new Xt).parse(t.args);return s.help.isSet?s.writeHelp(n):s.clear.isSet?e.clear():e.write(n),0}}class Gt extends xt{description="Locate built-in commands by name. Prints each given command if it exists, otherwise an error message.";help=new ut("h","help","display this help and exit");positional=new dt({tabComplete:async t=>({possibles:t.commandRegistry?.commandNames()??[]})})}class Jt extends ct{get name(){return"which"}async tabComplete(t){return await(new Gt).tabComplete(t)}async _run(t){const{args:e,stdout:n}=t,s=new Set(t.commandRegistry?.commandNames()),i=(new Gt).parse(t.args);if(i.help.isSet)return i.writeHelp(n),0;if(0===i.positional.strings.length)return n.write("which: missing operand\n"),i.writeHelp(n),1;let r=0;for(const n of e)s.has(n)?t.stdout.write(`${n}\n`):(t.stdout.write(`which: no ${n} command\n`),r=1);return r}}class Kt{callExternalCommand;callExternalTabComplete;constructor(e,n){this.callExternalCommand=e,this.callExternalTabComplete=n,this.registerBuiltinCommands(t)}allModules(){const t=[];for(const e of this.commandPackageMap.values())t.push(...e.modules);return t.sort((t,e)=>t.name<e.name?-1:1),t}commandNames(t=Y.All){return t===Y.None?[]:t===Y.All?Array.from(this._map.keys()).sort():Array.from(this._map).filter(([e,n])=>(n.commandType&t)>0).map(([t,e])=>t).sort()}get(t){return this._map.get(t)??null}match(t,e=Y.All){return this.commandNames(e).filter(e=>e.startsWith(t))}registerBuiltinCommands(t){for(const[e,n]of Object.entries(t))if(e.endsWith("Command")&&!e.startsWith("Builtin"))try{const t=new n;t instanceof ct&&this._register(t)}catch{}}registerCommandPackage(t){this.commandPackageMap.set(t.name,t);for(const e of t.modules)this._register(e.runner)}registerExternalCommand(t,e){this._map.set(t,new lt(t,this.callExternalCommand,e?this.callExternalTabComplete:void 0))}_register(t){for(const e of t.names())this._map.set(e,t)}_map=new Map;commandPackageMap=new Map}class Zt{module;constructor(t){this.module=t}get moduleName(){return this.module.moduleName}names(){return this.module.names}get packageName(){return this.module.packageName}}class te{input;constructor(t){this.input=t}isTerminal(){return this.input.isTerminal()}async readAsync(t){const e=await this.input.readAsync(t);return String.fromCharCode(...e)}}class ee extends Zt{module;constructor(t){super(t),this.module=t}get commandType(){return Y.JavaScript}async run(t){const{name:e}=t,n=this.module.loader.getJavaScriptModule(this.packageName,this.moduleName);if(void 0===n)throw new it(e);if(!Object.prototype.hasOwnProperty.call(n,"run"))throw new rt(e);const{args:s,environment:i,fileSystem:r,shellId:o,stdout:a,stderr:l,termios:c,size:h}=t,u={name:e,args:s,environment:i,fileSystem:r,shellId:o,stdin:new te(t.stdin),stdout:a,stderr:l,size:h,termios:c};try{return await n.run(u)}catch(t){throw console.error(`JavascriptCommandRunner: ${t}`),new at(e)}}async tabComplete(t){const e=this.module.loader.getJavaScriptModule(this.packageName,this.moduleName);if(void 0!==e&&Object.prototype.hasOwnProperty.call(e,"tabComplete")&&void 0!==e.tabComplete){const{name:n,args:s,shellId:i}=t;try{return await e.tabComplete({name:n,args:s,shellId:i})}catch(t){}}return{}}}class ne extends Zt{module;constructor(t){super(t),this.module=t}get commandType(){return Y.Wasm}async run(t){const{name:e,args:n,workerIO:s,fileSystem:i,stdin:r,stdout:o,stderr:a,termios:l,size:c}=t,{wasmBaseUrl:h}=this.module.loader,u=Date.now(),d=this.module.loader.getWasmModule(this.packageName,this.moduleName);if(void 0===d)throw new it(e);function m(t){return l.get()}function f(t,e,n){return l.set(n),0}function p(t){return c()}function g(t,e){return s.poll(e)}function _(t,e,n,s,i){if(0===s)return 0;let o=r.read(s);return 1===o.length&&4===o[0]&&(o=[]),e.set(o,n),o.length}function w(t,i,r,l,c){if(0===l)return 0;const h=i.slice(r,r+l),u=s.utf8ArrayToString(h),d="/dev/tty1"===t.path;return d&&"touch"===e&&n.length>1||(d?a:o).write(u),l}let y;function C(t){void 0===y&&(y=t)}const v=await d({thisProgram:e,arguments:n,locateFile:t=>b(h,this.packageName+"/"+t),onExit:t=>C(t),quit:(t,e)=>C(t),preRun:[e=>{if(Object.prototype.hasOwnProperty.call(e,"FS")){const t=e.FS,{mountpoint:n}=i;t.mkdir(n,511),t.mount(i.PROXYFS,{root:n,fs:i.FS},n),t.chdir(i.FS.cwd())}Object.prototype.hasOwnProperty.call(e,"ENV")&&t.environment.copyIntoCommand(e.ENV,o.isTerminal()),Object.prototype.hasOwnProperty.call(e,"TTY")&&(e.TTY.default_tty_ops.ioctl_tcgets=m,e.TTY.default_tty_ops.ioctl_tcsets=f,e.TTY.default_tty_ops.ioctl_tiocgwinsz=p,e.TTY.stream_ops.poll=g,e.TTY.stream_ops.read=_,e.TTY.stream_ops.write=w)}],stderr:this._outputHandler(a),stdout:this._outputHandler(o)});if(void 0===y)y=126;else if(Object.prototype.hasOwnProperty.call(v,"FS")){const t=v.FS;for(const e of[t.streams[1],t.streams[2]])null===e||t.isClosed(e)||t.close(e)}const x=Date.now();return console.debug(`Cockle ${e} load and run time ${x-u} ms`),y}_outputHandler(t){if(!t.isTerminal())return e=>t.write(String.fromCharCode(e))}}class se{commandModuleLoader;name;commands;packageName;wasm;constructor(t,e,n,s,i){this.commandModuleLoader=t,this.name=e,this.commands=n,this.packageName=s,this.wasm=i}get loader(){return this.commandModuleLoader}get runner(){return void 0===this._runner&&(this._runner=this.wasm?new ne(this):new ee(this)),this._runner}get moduleName(){return this.name}get names(){return this.commands}_runner}class ie{name;version;build_string;channel;platform;wasm;modules;constructor(t,e,n,s,i,r,o){this.name=t,this.version=e,this.build_string=n,this.channel=s,this.platform=i,this.wasm=r,this.modules=o}}class re extends Map{constructor(t){super(),t?(this.set("PS1",V+"js-shell:"+W+" "),this.set("TERM","xterm-256color"),this.set("TERMINFO","/usr/local/share/terminfo")):this.set("PS1","js-shell: ")}copyIntoCommand(t,e){for(const[n,s]of this.entries())(e||"TERM"!==n)&&(t[n]=s)}getNumber(t){const e=this.get(t);if(null===e)return null;const n=Number(e);return isNaN(n)?null:n}getPrompt(){return this.get("PS1")??"$ "}get color(){return this.has("TERM")}setSize(t,e){if(t>=1){const e=t.toString();this.set("LINES",e),this.set("LESS_LINES",e)}else this.delete("LINES"),this.delete("LESS_LINES");if(e>=1){const t=e.toString();this.set("COLUMNS",t),this.set("LESS_COLUMNS",t)}else this.delete("COLUMNS"),this.delete("LESS_COLUMNS")}}class oe{add(t){this._current=null,!t.trim()||this._ignoreInitialWhitespace&&t.startsWith(" ")||this._ignoreDuplicates&&t===this.at(-1)||(this._history.length>=this._maxSize&&this._history.shift(),this._history.push(t))}at(t){return this._history.at(t)??null}clear(){this._current=null,this._history=[]}scrollCurrent(t){return this._current=t?null===this._current?null:this._current+1:null===this._current?this._history.length-1:this._current-1,null!==this._current&&(this._current<0?this._current=0:this._current>=this._history.length&&(this._current=null)),null===this._current?null:this.at(this._current)}setMaxSize(t){this._maxSize=Math.max(t,0),this._history.length>this._maxSize&&(this._current=null,this._history=this._history.slice(this._maxSize))}write(t){for(let e=0;e<this._history.length;e++){const n=String(e).padStart(5," ");t.write(`${n}  ${this._history[e]}\n`)}}_history=[];_current=null;_ignoreInitialWhitespace=!0;_ignoreDuplicates=!0;_maxSize=1e3}class ae{outputCallback;constructor(t,e,n){this.outputCallback=t,this.prefix=e,this.suffix=n}flush(){}isTerminal(){return!0}supportsAnsiEscapes(){return!0}write(t){t.length<1||(void 0!==this.prefix&&(t=this.prefix+t),void 0!==this.suffix&&(t+=this.suffix),this.outputCallback(t))}prefix;suffix}class le{stdinCallback;stdinAsyncCallback;constructor(t,e){this.stdinCallback=t,this.stdinAsyncCallback=e}isTerminal(){return!0}async readAsync(t){return await this.stdinAsyncCallback(t)}read(t){return this.stdinCallback(t)}}class ce{get allContent(){return this.data.join("")}clear(){this.data=[]}isTerminal(){return!1}supportsAnsiEscapes(){return!1}write(t){this.data.push(t)}data=[]}class he{isTerminal(){return!1}async readAsync(t){return this.read(t)}read(t){if(void 0===this._buffer&&(this._buffer=this.readAll(),this._index=0),this._index<this._buffer.length){const t=this._buffer[this._index++],e=[];for(let n=0;n<t.length;n++)e.push(t.charCodeAt(n));return e}return[]}_buffer;_index=0}class ue extends he{pipe;constructor(t){super(),this.pipe=t}readAll(){const t=this.pipe.allContent;return this.pipe.clear(),t}}class de extends ce{flush(){}get input(){return new ue(this)}}class me extends ce{fileSystem;path;append;constructor(t,e,n){super(),this.fileSystem=t,this.path=e,this.append=n}flush(){const{FS:t}=this.fileSystem;let e=this.allContent;if(this.append)try{e=t.readFile(this.path,{encoding:"utf8"})+e}catch(t){}t.writeFile(this.path,e,{mode:436}),this.clear()}}class fe extends he{fileSystem;path;constructor(t,e){super(),this.fileSystem=t,this.path=e}readAll(){const{FS:t}=this.fileSystem;return t.readFile(this.path,{encoding:"utf8"})}}class pe{isTerminal(){return!1}async readAsync(t){return[]}read(t){return[]}}class ge{flush(){}isTerminal(){return!1}supportsAnsiEscapes(){return!1}write(t){}}!function(t){t[t.None=0]="None",t[t.Delimiter=1]="Delimiter",t[t.DoubleQuote=2]="DoubleQuote",t[t.SingleQuote=3]="SingleQuote",t[t.Whitespace=4]="Whitespace",t[t.Other=5]="Other"}(_t||(_t={}));class _e{throwErrors;aliases;constructor(t,e,n){this.throwErrors=e,this.aliases=n,this._source=t,this._tokens=[]}run(){for(;this._index<=this._source.length;)this._next();if(this.throwErrors&&""!==this._endQuote)throw new ot("Tokenize error, expected end quote "+this._endQuote)}get tokens(){return this._tokens}_addToken(){const t=this._offset,e=this._value;if(void 0!==this.aliases&&t!==this._aliasOffset&&(0===this._tokens.length||";&|".includes(this._tokens.at(-1).value.at(-1)))){const n=this.aliases.getRecursive(e);if(void 0!==n){const s=e.length;return this._offset=-1,this._index=t-1,this._aliasOffset=t,this._source=this._source.slice(0,t)+n+this._source.slice(t+s),this._prevChar="",this._prevCharType=_t.None,this._value="",this._endQuote="",!1}}return this._tokens.push({offset:t,value:e}),this._endQuote="",!0}_getCharType(t){return" ".includes(t)?_t.Whitespace:";&|><".includes(t)?_t.Delimiter:"'"===t?_t.SingleQuote:'"'===t?_t.DoubleQuote:_t.Other}_endQuoteFromCharType(t){return t===_t.DoubleQuote?'"':t===_t.SingleQuote?"'":""}_next(){const t=++this._index,e=t<this._source.length?this._source[t]:" ";let n=this._getCharType(e);const s=this._endQuoteFromCharType(n);this._offset>=0?this._endQuote?e!==this._endQuote?this._value+=e:(this._endQuote="",n=_t.Other):s?this._endQuote=s:n===_t.Whitespace?this._addToken()&&(this._offset=-1):n!==this._prevCharType||n===_t.Delimiter&&e!==this._prevChar?this._addToken()&&(this._offset=t,this._value=e):this._value+=e:n!==_t.Whitespace&&(this._offset=t,this._endQuote=this._endQuoteFromCharType(n),this._value=""===this._endQuote?e:""),this._prevChar=e,this._prevCharType=n}_source;_tokens;_prevChar="";_prevCharType=_t.None;_index=-1;_offset=-1;_aliasOffset=-1;_value="";_endQuote=""}class we{}class ye extends we{name;suffix;redirects;constructor(t,e,n){super(),this.name=t,this.suffix=e,this.redirects=n}lastToken(){return this.redirects&&this.redirects.length>0?this.redirects[this.redirects.length-1].lastToken():this.suffix.length>0?[this.suffix[this.suffix.length-1],!1]:[this.name,!0]}}class Ce extends we{commands;constructor(t){super(),this.commands=t}lastToken(){return this.commands.length>0?this.commands[this.commands.length-1].lastToken():[null,!1]}}class ve extends we{token;target;constructor(t,e){super(),this.token=t,this.target=e}lastToken(){return[this.target,!1]}}function xe(t,e=!0,n){const s=function(t,e=!0,n){const s=new _e(t,e,n);return s.run(),s.tokens}(t,e,n),i=[],r=[];let o=-1;const a=s.length;function l(){1===r.length?i.push(r[0]):r.length>1&&i.push(new Ce([...r])),r.length=0}for(let t=0;t<a;t++){const e=s[t];o>=0?";&".includes(e.value)?(r.push(be(s.slice(o,t))),l(),o=-1):"|"===e.value&&(r.push(be(s.slice(o,t))),o=-1):";&".includes(e.value)||(o=t)}return o>=0&&r.push(be(s.slice(o,a))),l(),i}function be(t){let e=t.slice(1);const n=e.findIndex(t=>{return(e=t.value).startsWith(">")||e.startsWith("<");var e});if(n>=0){if(e.length!==n+2)throw new ot("Redirect should be followed by file to redirect to");const s=new ve(e[n],e[n+1]);return e=e.slice(0,n),new ye(t[0],e,[s])}return new ye(t[0],e)}class Se{context;constructor(t){this.context=t}async complete(t){const e=t.text.slice(0,t.cursorIndex),n=t.text.slice(t.cursorIndex),s=xe(e,!1).at(-1),[i,r]=e.endsWith(" ")?[null,!1]:void 0!==s?s.lastToken():[null,!0];let o=i?.value??"",a={pathType:gt.Any};if(r)a={possibles:this._getPossibleCompletionsCommand(o)};else if(s instanceof ye){const t=s,e=t.name.value,n=this.context.commandRegistry.get(e);if(null!==n&&void 0!==n.tabComplete){const s=t.suffix.map(t=>t.value);o||s.push("");const{commandRegistry:i,stdinContext:r}=this.context;a=await n.tabComplete({name:e,args:s,commandRegistry:i,shellId:this.context.shellId,stdinContext:r})}}const l=a.possibles??[];if(void 0!==a.pathType){let e=[];[t,o,e]=this._getPossibleCompletionsFileSystem(t,o,a.pathType),l.push(...e)}if(0===l.length)return t;if(l.sort(),1===l.length){let e=l[0].slice(o.length);return e.endsWith("/")||(e+=" "),t.text=t.text.slice(0,t.cursorIndex)+e+n,t.cursorIndex+=e.length,this.context.workerIO.write(e+n+R(n.length)),t}const c=function(t,e=0){if(t.length<1)return"";const n=Math.min(...t.map(t=>t.length)),s=t[0];let i=e;for(;i<n&&t.every(t=>t[i]===s[i]);)i++;return s.slice(0,i)}(l,o.length);if(c.length>o.length){const e=c.slice(o.length);return t.text=t.text.slice(0,t.cursorIndex)+e+n,t.cursorIndex+=e.length,this.context.workerIO.write(e+n+R(n.length)),t}return await this._showPossibleCompletions(t,n,l),t}_getPossibleCompletionsCommand(t){const e=this.context.commandRegistry.match(t),n=this.context.aliases.match(t);return[...new Set([...e,...n])]}_getPossibleCompletionsFileSystem(t,e,n){const{FS:s,PATH:i}=this.context.fileSystem;e||(e="./");const r=e.endsWith("/"),o=[void 0,"/"],a=e.endsWith("..")&&o.includes(e.at(-3)),l=!a&&e.endsWith(".")&&o.includes(e.at(-2)),c=l||a;a&&(e=e.slice(0,-1));const h=s.analyzePath(e,!0),u=r||c?h.path:h.parentPath,d=c?l?".":"..":r?"":h.name;let m=s.readdir(u);r&&(m=m.filter(t=>!t.startsWith("."))),m=m.filter(t=>t.startsWith(d));const f=new Ee(s);return n===gt.Directory?m=m.filter(t=>f.isDir(i.join(u,t))):n===gt.File&&(m=m.filter(t=>f.isFile(i.join(u,t)))),n!==gt.File&&(m=m.map(t=>f.isDir(i.join(u,t))?t+"/":t)),[t,d,m]}async _showPossibleCompletions(t,e,n){const{environment:s}=this.context,i=`\n${function(t,e){if(t.length<1)return[];if(e<1)return[t.join("  ")];const n=t.length,s=Math.max(...t.map(t=>t.length)),i=Math.min(Math.floor(e/(s+2)),n),r=Math.ceil(n/i),o=[];for(let e=0;e<r;++e){let a="";for(let o=0;o<i;++o){const i=o*r+e;if(i>=n)continue;const l=t[i];a+=l,i+r<n&&(a+=" ".repeat(s+2-l.length))}o.push(a)}return o}(n,s.getNumber("COLUMNS")??0).join("\n")}\n${s.getPrompt()}${t.text}`;this.context.workerIO.write(i+R(e.length))}}class Ee{FS;constructor(t){this.FS=t}isDir(t){return this.FS.isDir(this._stat(t).mode)}isFile(t){return this.FS.isFile(this._stat(t).mode)}_stat(t){let e=this._statCache.get(t);return void 0===e&&(e=this.FS.stat(t,!1),this._statCache.set(t,e)),e}_statCache=new Map}class Oe{constructor(t){this._options=t,this._commandModuleLoader=new nt(t.wasmBaseUrl,t.downloadModuleCallback),this._fileSystem={FS:void 0,PATH:void 0,ERRNO_CODES:void 0,PROXYFS:void 0,mountpoint:t.mountpoint??"/drive"};const e=t.workerIO;this._runContext={name:"",args:[],fileSystem:this._fileSystem,aliases:new tt,commandRegistry:new Kt(t.callExternalCommand,t.callExternalTabComplete),environment:new re(t.color),history:new oe,shellId:t.shellId,terminate:this.terminate.bind(this),stdin:this._dummyInput,stdout:this._dummyOutput,stderr:this._dummyOutput,size:()=>this.size,termios:t.termios,workerIO:e,commandModuleCache:this._commandModuleLoader.cache,stdinContext:t.stdinContext},Object.entries(t.aliases).forEach(([t,e])=>this._runContext.aliases.set(t,e)),Object.entries(t.environment).forEach(([t,e])=>{void 0===e?this._runContext.environment.delete(t):this._runContext.environment.set(t,e)}),t.externalCommandConfigs.forEach(t=>this._runContext.commandRegistry.registerExternalCommand(t.name,t.hasTabComplete)),this._stderr=new ae(this.output.bind(this),this._options.color?z:void 0,this._options.color?W:void 0),this._tabCompleter=new Se(this._runContext)}get aliases(){return this._runContext.aliases}get environment(){return this._runContext.environment}get exitCode(){return this._exitCode}async externalInput(t){const e=await this._runContext.stdin.readAsync(t);return String.fromCharCode(...e)}externalOutput(t,e){(e?this._runContext.stderr:this._runContext.stdout).write(t)}get history(){return this._runContext.history}async initialize(){await this._initWasmPackages(),await this._initFileSystem()}async input(t){if(!this._isRunning)return;const e=t.length;for(let n=0;n<e;++n){const e=t[n];switch(e.charCodeAt(0)){case 13:{this.output("\n");const t=this._commandLine.text;this._commandLine.text="",this._commandLine.cursorIndex=0,t.length>0&&await this._runCommands(t),await this._outputPrompt();break}case 127:if(this._commandLine.cursorIndex>0){const{cursorIndex:t,text:e}=this._commandLine,n=e.slice(t);this._commandLine.text=e.slice(0,t-1)+n,this._commandLine.cursorIndex--,this.output(R(1)+n+D+R(n.length))}break;case 9:this._commandLine=await this._tabCompleter.complete(this._commandLine);break;case 27:n+=this._escapedInput(t,n);break;case 4:break;default:if(this._commandLine.cursorIndex===this._commandLine.text.length)this._commandLine.text+=e,this.output(e);else{const{cursorIndex:t,text:n}=this._commandLine,s=n.slice(t);this._commandLine.text=n.slice(0,t)+e+s,this.output(D+e+s+R(s.length))}this._commandLine.cursorIndex++}}}output(t){this._isRunning&&this._runContext.workerIO.write(t)}setSize(t,e){this._size=[t,e],this.environment.setSize(t,e)}setWorkerIO(t){this._runContext.workerIO=t}get size(){return this._size}async start(){this._isRunning=!0,await this._outputPrompt()}terminate(){console.log("Cockle ShellImpl.terminate"),this._isRunning=!1,this._options.terminateCallback()}async themeChange(t){this._requestedDarkMode=t,this._themeStatus===wt.Ok&&(this._themeStatus=wt.PendingChange,this._runContext.workerIO.enabled||await this._handleThemeChange())}_escapedInput(t,e){if("["!==t.at(e+1))return 0;const n=/^[^A-Z~]*[A-Z~]/.exec(t.slice(e+2));if(null===n)return 1;const s=n[0];switch(s){case"A":case"1A":case"B":case"1B":{const t=this.history.scrollCurrent(s.endsWith("B"));this._commandLine.text=null!==t?t:"",this._commandLine.cursorIndex=this._commandLine.text.length,this.output(D+F+`\r${this.environment.getPrompt()}${this._commandLine.text}`);break}case"D":case"1D":this._commandLine.cursorIndex>0&&(this._commandLine.cursorIndex--,this.output(R()));break;case"C":case"1C":this._commandLine.cursorIndex<this._commandLine.text.length&&(this._commandLine.cursorIndex++,this.output(A()));break;case"3~":if(this._commandLine.cursorIndex<this._commandLine.text.length){const{cursorIndex:t,text:e}=this._commandLine,n=e.slice(t+1);this._commandLine.text=e.slice(0,t)+n,this.output(D+n+R(n.length))}break;case"H":case"1;2H":this._commandLine.cursorIndex>0&&(this.output(R(this._commandLine.cursorIndex)),this._commandLine.cursorIndex=0);break;case"F":case"1;2F":{const{length:t}=this._commandLine.text;this._commandLine.cursorIndex<t&&(this.output(A(t-this._commandLine.cursorIndex)),this._commandLine.cursorIndex=t);break}case"1;2D":case"1;5D":if(this._commandLine.cursorIndex>0){const{cursorIndex:t,text:e}=this._commandLine,n=e.slice(0,t).trimEnd().lastIndexOf(" ")+1;this.output(R(t-n)),this._commandLine.cursorIndex=n}break;case"1;2C":case"1;5C":{const{length:t}=this._commandLine.text;if(this._commandLine.cursorIndex<t-1){const{cursorIndex:e,text:n}=this._commandLine,s=n.slice(e),i=s.trimStart(),r=i.indexOf(" "),o=r<0?t:e+s.length-i.length+r;this.output(A(o-e)),this._commandLine.cursorIndex=o}break}default:console.warn(`Unrecognised escape sequence '[${s}'`)}return s.length+1}_filenameExpansion(t){const{PATH:e}=this._runContext.fileSystem;let n=[],s=0;for(const i of t){if(i.startsWith("-")){s++,n.push(i);continue}if(!i.includes("*")&&!i.includes("?")){n.push(i);continue}const{FS:t}=this._runContext.fileSystem,r=t.analyzePath(i,!1);if(!r.parentExists){n.push(i);continue}const o=r.parentPath;let a=o;const l=t.cwd();a.startsWith(l)&&(a=a.slice(l.length),a.startsWith("/")&&(a=a.slice(1)));let c=t.readdir(o),h=r.name.replace(/[.+^${}()|[\]\\]/g,"\\$&");h=h.replaceAll("*",".*"),h=h.replaceAll("?",".");const u=new RegExp(`^${h}$`);c=c.filter(t=>t.match(u)),c=c.filter(t=>!t.startsWith(".")),a.length>0&&(c=c.map(t=>e.join(a,t))),n=n.concat(c)}return n.length===s&&(n=t),n}async _handleThemeChange(){if(this._themeStatus===wt.Changing)return;if(void 0!==this._requestedDarkMode)return void this._setDarkMode(this._requestedDarkMode);this._themeStatus=wt.Changing,await this._options.enableBufferedStdinCallback(!0);const{termios:t,workerIO:e}=this._options;t.setRawMode(),this.output("]11;?");const n=Date.now(),s=await e.readAsync(null,100);console.debug("Cockle theme change",Date.now()-n,"ms"),t.setDefaultShell(),await this._options.enableBufferedStdinCallback(!1),this._themeStatus=wt.Ok;const i=String.fromCharCode(...s),r=/^\x1b]11;rgb:([0-9A-Fa-f]{2,})\/([0-9A-Fa-f]{2,})\/([0-9A-Fa-f]{2,})\x1b\\$/.exec(i);if(r){const t=(parseInt(r[1].slice(0,2),16)/255+parseInt(r[2].slice(0,2),16)/255+parseInt(r[3].slice(0,2),16)/255)/3;this._setDarkMode(t<.6)}else console.warn("Unable to determine terminal background color"),this._setDarkMode(void 0)}async _initFileSystem(){const{wasmBaseUrl:t}=this._options,e=this._commandModuleLoader.getWasmModule("cockle_fs","fs");if(void 0===e)return void console.error("Unable to load cockle_fs, shell cannot function");const n=await e({locateFile:e=>b(t,"cockle_fs/"+e)}),{FS:s,PATH:i,ERRNO_CODES:r,PROXYFS:o}=n,a=this._fileSystem.mountpoint;s.mkdirTree(a,511),this._runContext.fileSystem.FS=s,this._runContext.fileSystem.PATH=i,this._runContext.fileSystem.ERRNO_CODES=r,this._runContext.fileSystem.PROXYFS=o;const{browsingContextId:l,baseUrl:c,initialDirectories:h,initialFiles:u}=this._options;this._options.initDriveFSCallback({browsingContextId:l,baseUrl:c,fileSystem:this._runContext.fileSystem,mountpoint:a}),s.chdir(a),this.environment.set("PWD",s.cwd()),h&&h.forEach(t=>s.mkdir(t,509)),u&&Object.entries(u).forEach(([t,e])=>s.writeFile(t,e,{mode:436}))}async _initWasmPackages(){const t=b(this._options.wasmBaseUrl,"cockle-config.json"),e=await fetch(t);e.ok||console.error(`Failed to fetch ${t}, terminal cannot function without it`);const n=await e.json(),s=Object.keys(n.packages),i="cockle_fs";s.includes(i)||console.error(`cockle-config.json does not include required package '${i}'`);for(const t of s){const e=n.packages[t],s=Object.entries(e.modules).map(([n,s])=>new se(this._commandModuleLoader,n,s.commands?s.commands.split(","):[],t,e.wasm)),i=new ie(t,e.version,e.build_string,e.channel,e.platform,e.wasm,s);this._runContext.commandRegistry.registerCommandPackage(i)}if(Object.hasOwn(n,"aliases"))for(const[t,e]of Object.entries(n.aliases)){const n=e;n.length>0&&this.aliases.set(t,n)}if(Object.hasOwn(n,"environment"))for(const[t,e]of Object.entries(n.environment)){const n=e;n.length>0&&this.environment.set(t,n)}}async _outputPrompt(){this._isRunning&&(this._themeStatus===wt.PendingChange&&await this._handleThemeChange(),this._runContext.workerIO.write(`\n${this.environment.getPrompt()}`))}async _runCommands(t){if(t.startsWith("!")){const e=parseInt(t.slice(1)),n=this.history.at(e);if(null===n){let t="!"+e+": event not found";return this._options.color&&(t=B+t+W),this.output(`${t}\n`),void await this._outputPrompt()}t=n}let e;await this._options.enableBufferedStdinCallback(!0),this._options.termios.setDefaultWasm(),this.history.add(t);const n=new le(this._stdinCallback.bind(this),this._stdinAsyncCallback.bind(this)),s=new ae(this.output.bind(this)),i=this._stderr;try{const r=xe(t,!0,this.aliases);for(const t of r)if(t instanceof ye)e=await this._runCommand(t,n,s,i);else{if(!(t instanceof Ce))throw new ot(`Expected CommandNode or PipeNode not ${t}`);{const{commands:e}=t,r=e.length;let o;for(let t=0;t<r;t++){const a=0===t?n:o.input,l=t<r-1?o=new de:s;await this._runCommand(e[t],a,l,i)}}}}catch(t){t instanceof st&&(e=t.exitCode),i.write(t+"\n"),i.flush()}finally{e=e??1,this._setExitCode(e),this._options.termios.setDefaultShell(),await this._options.enableBufferedStdinCallback(!1)}}async _runCommand(t,e,n,s){const i=t.name.value,r=this._runContext.commandRegistry.get(i);if(null===r)throw new it(i);if(t.redirects){if(t.redirects.length>1)throw new ot("Only implemented a single redirect per command");const s=t.redirects[0],i=s.token.value,r=s.target.value;if(">"===i||">>"===i)n=new me(this._runContext.fileSystem,r,">>"===i);else{if("<"!==i)throw new ot("Unrecognised redirect "+i);e=new fe(this._runContext.fileSystem,r)}}let o=t.suffix.map(t=>t.value);o=this._filenameExpansion(o),this._runContext.name=i,this._runContext.args=o,this._runContext.stdin=e,this._runContext.stdout=n,this._runContext.stderr=s;let a=-1;try{a=await r.run(this._runContext)}finally{s.flush(),n.flush(),this._runContext.name="",this._runContext.args=[],this._runContext.stdin=this._dummyInput,this._runContext.stdout=this._dummyOutput,this._runContext.stderr=this._dummyOutput}return a}_setDarkMode(t){if(t===this._darkMode)return;if(this._darkMode=t,this._options.color){this._stderr.prefix=t?j:z;const e=t?U:V;this._runContext.environment.set("PS1",e+"js-shell:"+W+" ")}const e="COCKLE_DARK_MODE";void 0===t?this.environment.delete(e):this.environment.set(e,t?"1":"0")}_setExitCode(t){this._exitCode=t,this.environment.set("?",`${t}`)}_stdinCallback(t){return this._runContext.workerIO.read(t)}async _stdinAsyncCallback(t){return await this._runContext.workerIO.readAsync(t,-1)}_commandLine={text:"",cursorIndex:0};_darkMode;_exitCode=0;_requestedDarkMode;_isRunning=!1;_size=[0,0];_themeStatus=wt.PendingChange;_commandModuleLoader;_runContext;_dummyInput=new pe;_dummyOutput=new ge;_fileSystem;_options;_stderr;_tabCompleter}!function(t){t[t.Ok=0]="Ok",t[t.PendingChange=1]="PendingChange",t[t.Changing=2]="Changing"}(wt||(wt={}));class Ie{async initialize(t,e,n,s,i,r,o,a){if(this._stdinContext=new Z(o,this._setWorkerIO.bind(this)),t.supportsServiceWorker&&(this._serviceWorkerWorkerIO=new J(r,this._termios,t.baseUrl??"",t.browsingContextId??"",t.shellId),this._stdinContext.setAvailable("sw",!0)),void 0!==t.sharedArrayBuffer&&(this._sharedArrayBufferWorkerIO=new K(r,this._termios,t.sharedArrayBuffer),this._stdinContext.setAvailable("sab",!0)),this._workerIO=this._sharedArrayBufferWorkerIO??this._serviceWorkerWorkerIO,void 0===this._workerIO)throw new Error("ABORT: does not support SharedArrayBuffer or ServiceWorker!");this._stdinContext.setEnabled(this._workerIO===this._sharedArrayBufferWorkerIO?"sab":"sw"),this._downloadModuleCallback=s,this._enableBufferedStdinCallback=i,this._terminateCallback=a,this._shellImpl=new Oe({shellId:t.shellId,color:t.color,mountpoint:t.mountpoint,baseUrl:t.baseUrl,wasmBaseUrl:t.wasmBaseUrl,browsingContextId:t.browsingContextId,aliases:t.aliases,environment:t.environment,externalCommandConfigs:t.externalCommandConfigs,initialDirectories:t.initialDirectories,initialFiles:t.initialFiles,callExternalCommand:e,callExternalTabComplete:n,downloadModuleCallback:this._downloadModuleCallback.bind(this),enableBufferedStdinCallback:this.enableBufferedStdin.bind(this),initDriveFSCallback:this.initDriveFS.bind(this),terminateCallback:this._terminateCallback.bind(this),workerIO:this._workerIO,stdinContext:this._stdinContext,termios:this._termios}),await this._shellImpl.initialize()}async enableBufferedStdin(t){t?(await(this._workerIO?.canEnable()),this._enableBufferedStdinCallback&&await this._enableBufferedStdinCallback(!0),await(this._workerIO?.enable())):(this._enableBufferedStdinCallback&&await this._enableBufferedStdinCallback(!1),await(this._workerIO?.disable()))}get exitCode(){return this._shellImpl?.exitCode??1}async externalInput(t){return this._shellImpl.externalInput(t)}externalOutput(t,e){this._shellImpl?.externalOutput(t,e)}externalSetTermios(t){this._termios.set(t)}async input(t){this._shellImpl&&await this._shellImpl.input(t)}setSize(t,e){this._shellImpl&&this._shellImpl.setSize(t,e)}async start(){this._shellImpl&&await this._shellImpl.start()}async themeChange(t){await(this._shellImpl?.themeChange(t))}_setWorkerIO(t){const e=this._workerIO;if("sab"===t&&void 0!==this._sharedArrayBufferWorkerIO)this._workerIO=this._sharedArrayBufferWorkerIO;else{if("sw"!==t||void 0===this._serviceWorkerWorkerIO)throw new Error(`Cannot set WorkerIO to '${t}'`);this._workerIO=this._serviceWorkerWorkerIO}e?.disable(),this._shellImpl?.setWorkerIO(this._workerIO)}_shellImpl;_downloadModuleCallback;_enableBufferedStdinCallback;_terminateCallback;_stdinContext;_serviceWorkerWorkerIO;_sharedArrayBufferWorkerIO;_termios=new Q.Termios;_workerIO}const ke=new TextEncoder,Ne=new TextDecoder("utf-8"),Te={0:!1,1:!0,2:!0,64:!0,65:!0,66:!0,129:!0,193:!0,514:!0,577:!0,578:!0,705:!0,706:!0,1024:!0,1025:!0,1026:!0,1089:!0,1090:!0,1153:!0,1154:!0,1217:!0,1218:!0,4096:!0,4098:!0};class Ae{constructor(t){this.fs=t}open(t){var e;const n=this.fs.realPath(t.node);if(this.fs.FS.isFile(t.node.mode))try{const e=this.fs.API.get(n);t.file=e}catch(s){const i=null!==(e=t.flags)&&void 0!==e?e:t.shared.flags;let r="string"==typeof i?parseInt(i,10):i;r&=8191;let o=!0;if(r in Te&&(o=Te[r]),!o)throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.ENOENT);{t.node=this.fs.node_ops.mknod(t.node.parent,t.node.name,t.node.mode,0);const e=this.fs.API.get(n);t.file=e}}}close(t){var e;if(!this.fs.FS.isFile(t.node.mode)||!t.file)return;const n=this.fs.realPath(t.node),s=null!==(e=t.flags)&&void 0!==e?e:t.shared.flags;let i="string"==typeof s?parseInt(s,10):s;i&=8191;let r=!0;i in Te&&(r=Te[i]),r&&this.fs.API.put(n,t.file),t.file=void 0}read(t,e,n,s,i){if(s<=0||void 0===t.file||i>=(t.file.data.length||0))return 0;const r=Math.min(t.file.data.length-i,s);return e.set(t.file.data.subarray(i,i+r),n),r}write(t,e,n,s,i){var r;if(s<=0||void 0===t.file)return 0;const o=Date.now();if(t.node.timestamp=o,t.node.atime=o,t.node.mtime=o,t.node.ctime=o,i+s>((null===(r=t.file)||void 0===r?void 0:r.data.length)||0)){const e=t.file.data?t.file.data:new Uint8Array;t.file.data=new Uint8Array(i+s),t.file.data.set(e)}return t.file.data.set(e.subarray(n,n+s),i),s}llseek(t,e,n){var s;let i=e;if(1===n)i+=null!==(s=t.position)&&void 0!==s?s:t.shared.position;else if(2===n&&this.fs.FS.isFile(t.node.mode)){if(void 0===t.file)throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.EPERM);i+=t.file.data.length}if(i<0)throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.EINVAL);return i}}class Re{constructor(t){this.node=t=>function(t){return"node"in t}(t)?t.node:t,this.getattr=t=>{const e=this.node(t);return{...this.fs.API.getattr(this.fs.realPath(e)),mode:e.mode,ino:e.id}},this.setattr=(t,e)=>{const n=this.node(t);for(const[t,s]of Object.entries(e))switch(t){case"mode":n.mode=s;break;case"timestamp":n.timestamp=s;break;case"atime":n.atime=s;break;case"mtime":n.mtime=s;break;case"ctime":n.ctime=s;break;case"size":{const t=s,e=this.fs.realPath(n);if(this.fs.FS.isFile(n.mode)&&t>=0){let n;try{n=this.fs.API.get(e)}catch(t){break}const s=n.data?n.data:new Uint8Array;t!==s.length&&(t<s.length?n.data=n.data.slice(0,t):(n.data=new Uint8Array(t),n.data.set(s)),this.fs.API.put(e,n))}else console.warn("setattr size of",t,"on",n,"not yet implemented");break}case"dontFollow":break;default:console.warn("setattr",t,"of",s,"on",n,"not yet implemented")}},this.lookup=(t,e)=>{const n=this.node(t),s=this.fs.PATH.join2(this.fs.realPath(n),e),i=this.fs.API.lookup(s);if(!i.ok)throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.ENOENT);return this.fs.createNode(n,e,i.mode,0)},this.mknod=(t,e,n,s)=>{const i=this.node(t),r=this.fs.PATH.join2(this.fs.realPath(i),e);return this.fs.API.mknod(r,n),this.fs.createNode(i,e,n,s)},this.rename=(t,e,n)=>{const s=this.node(t),i=this.node(e);this.fs.API.rename(s.parent?this.fs.PATH.join2(this.fs.realPath(s.parent),s.name):s.name,this.fs.PATH.join2(this.fs.realPath(i),n)),s.name=n,s.parent=i},this.unlink=(t,e)=>this.fs.API.rmdir(this.fs.PATH.join2(this.fs.realPath(this.node(t)),e)),this.rmdir=(t,e)=>this.fs.API.rmdir(this.fs.PATH.join2(this.fs.realPath(this.node(t)),e)),this.readdir=t=>this.fs.API.readdir(this.fs.realPath(this.node(t))),this.symlink=(t,e,n)=>{throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.EPERM)},this.readlink=t=>{throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.EINVAL)},this.fs=t}}class Pe{constructor(t){this._driveName=t.driveName,this._mountpoint=t.mountpoint,this.FS=t.FS,this.ERRNO_CODES=t.ERRNO_CODES}lookup(t){return this.request({method:"lookup",path:this.normalizePath(t)})}getmode(t){return this.request({method:"getmode",path:this.normalizePath(t)})}mknod(t,e){return this.request({method:"mknod",path:this.normalizePath(t),data:{mode:e}})}rename(t,e){return this.request({method:"rename",path:this.normalizePath(t),data:{newPath:this.normalizePath(e)}})}readdir(t){const e=this.request({method:"readdir",path:this.normalizePath(t)});return e.push("."),e.push(".."),e}rmdir(t){return this.request({method:"rmdir",path:this.normalizePath(t)})}get(t){const e=this.request({method:"get",path:this.normalizePath(t)});if(!e)throw new this.FS.ErrnoError(this.ERRNO_CODES.ENOENT);const n=e.content,s=e.format;switch(s){case"json":case"text":return{data:ke.encode(n),format:s};case"base64":{const t=atob(n),e=t.length,i=new Uint8Array(e);for(let n=0;n<e;n++)i[n]=t.charCodeAt(n);return{data:i,format:s}}default:throw new this.FS.ErrnoError(this.ERRNO_CODES.ENOENT)}}put(t,e){switch(e.format){case"json":case"text":return this.request({method:"put",path:this.normalizePath(t),data:{format:e.format,data:Ne.decode(e.data)}});case"base64":{let n="";for(let t=0;t<e.data.byteLength;t++)n+=String.fromCharCode(e.data[t]);return this.request({method:"put",path:this.normalizePath(t),data:{format:e.format,data:btoa(n)}})}}}getattr(t){const e=this.request({method:"getattr",path:this.normalizePath(t)}),n=new Date(0);return e.atime=e.atime?new Date(e.atime):n,e.mtime=e.mtime?new Date(e.mtime):n,e.ctime=e.ctime?new Date(e.ctime):n,e.size=e.size||0,e}normalizePath(t){return t.startsWith(this._mountpoint)&&(t=t.slice(this._mountpoint.length)),this._driveName&&(t=`${this._driveName}:${t}`),t}}class Me extends Pe{constructor(t){super(t),this._baseUrl=t.baseUrl,this._browsingContextId=t.browsingContextId||""}request(t){const e=new XMLHttpRequest;e.open("POST",encodeURI(this.endpoint),!1);const n=I.UUID.uuid4(),s={data:{...t,requestId:n},browsingContextId:this._browsingContextId,requestId:n};try{e.send(JSON.stringify(s))}catch(t){console.error(t)}if(e.status>=400)throw new this.FS.ErrnoError(this.ERRNO_CODES.EINVAL);return JSON.parse(e.responseText)}get endpoint(){return`${this._baseUrl}api/drive`}}class Le{constructor(t){this.FS=t.FS,this.PATH=t.PATH,this.ERRNO_CODES=t.ERRNO_CODES,this.API=this.createAPI(t),this.driveName=t.driveName,this.node_ops=new Re(this),this.stream_ops=new Ae(this)}createAPI(t){if(!t.browsingContextId||!t.baseUrl)throw new Error("Cannot create service-worker API without current browsingContextId");return new Me(t)}mount(t){return this.createNode(null,t.mountpoint,16895,0)}createNode(t,e,n,s){const i=this.FS;if(!i.isDir(n)&&!i.isFile(n))throw new i.ErrnoError(this.ERRNO_CODES.EINVAL);const r=i.createNode(t,e,n,s);return r.node_ops=this.node_ops,r.stream_ops=this.stream_ops,r}getMode(t){return this.API.getmode(t)}realPath(t){const e=[];let n=t;for(e.push(n.name);n.parent!==n;)n=n.parent,e.push(n.name);return e.reverse(),this.PATH.join.apply(null,e)}}h(new class extends Ie{initDriveFS(t){const{baseUrl:e,browsingContextId:n,fileSystem:s,mountpoint:i}=t;if(console.log("Terminal initDriveFS",e,i,n),""!==i&&void 0!==e&&void 0!==n){const{FS:t,ERRNO_CODES:r,PATH:o}=s,a=new Le({FS:t,PATH:o,ERRNO_CODES:r,baseUrl:e,driveName:"",mountpoint:i,browsingContextId:n});t.mount(a,{},i),console.log("Terminal connected to shared drive")}else console.warn("Terminal not connected to shared drive")}})})()})();