"use strict";(self.webpackChunk_jupyterlite_terminal=self.webpackChunk_jupyterlite_terminal||[]).push([[385],{312:(t,e,s)=>{s.d(e,{X:()=>n});class n{isTerminal(){return!1}async readAsync(t){return[]}read(t){return[]}}},385:(t,e,s)=>{s.d(e,{g:()=>xt});var n={};s.r(n),s.d(n,{AliasCommand:()=>k,BuiltinCommand:()=>y,CdCommand:()=>L,ClearCommand:()=>D,CockleConfigCommand:()=>X,ExitCommand:()=>V,ExportCommand:()=>z,FalseCommand:()=>R,HelpCommand:()=>Y,HistoryCommand:()=>K,TrueCommand:()=>N,WhichCommand:()=>tt});var i=s(8301),r=s(7262),o=s(9399),a=s(4133),l=s(3291);class c{outputCallback;termios;constructor(t,e){this.outputCallback=t,this.termios=e}async canEnable(){await(this._available?.promise)}async disable(){this._enabled&&(this._enabled=!1,this._available?.resolve())}async enable(){this._enabled=!0,this._available=new r.PromiseDelegate}get enabled(){return this._enabled}poll(t){if(!this._enabled)throw new Error("WorkerIO.poll when disabled");let e=this._readBuffer.length>0;if(!e&&0!==t){const s=this._getStdin(t);this._postRead(s),e=this._readBuffer.length>0}return 4|(e?1:0)}read(t){if(!this._enabled)throw new Error("WorkerIO.read when disabled");if(null!==t&&t<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(t);const e=this._getStdin(-1);return this._postRead(e),this._readFromBuffer(t)}async readAsync(t,e){if(!this._enabled)throw new Error("WorkerIO.readAsync when disabled");if(null!==t&&t<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(t);const s=await this._getStdinAsync(e);return this._postRead(s),this._readFromBuffer(t)}utf8ArrayToString(t){return void 0===this._utf8Decoder&&(this._utf8Decoder=new TextDecoder("utf8")),this._utf8Decoder.decode(t)}write(t){let e=[];e="string"==typeof t?this._processWriteChars(t.split("").map(t=>t.charCodeAt(0))):this._processWriteChars(t),this.outputCallback(String.fromCharCode(...e))}_maybeEchoToOutput(t){const e=this.termios.get(),s=(e.c_lflag&a.G.LocalFlag.ECHO)>0,n=(e.c_lflag&a.G.LocalFlag.ECHONL)>0;if(!s&&!n)return;const i=[];for(const e of t)switch(e){case 10:i.push(10);break;case 4:break;default:s&&i.push(e)}i.length>0&&this.write(i)}_postRead(t){const e=t.split("").map(t=>t.charCodeAt(0)),s=this._processReadChars(e);this._readBuffer.push(...s),this._maybeEchoToOutput(s)}_processReadChars(t){const e=this.termios.get(),s=[];for(const n of t)switch(n){case 13:0===(e.c_iflag&a.G.InputFlag.IGNCR)&&((e.c_iflag&a.G.InputFlag.ICRNL)>0?s.push(10):s.push(13));break;case 10:(e.c_iflag&a.G.InputFlag.INLCR)>0?s.push(13):s.push(10);break;default:s.push(n)}return s}_processWriteChars(t){const e=this.termios.get(),{c_oflag:s}=e,n=[];for(let e=0;e<t.length;e++){const i=t[e];if(27===i){const s=t.at(e+1);if(91===s||93===s){const s=91===t[e+1],i=t.slice(e+2).findIndex(t=>s?(0,l.D$)(t):7===t||27===t);if(i>=0){const s=t.slice(e,e+i+3);n.push(...s),e+=i+2;const r=String.fromCharCode(...s);this._inAlternativeBuffer?r===o.Q.disableAlternativeBuffer&&(this._inAlternativeBuffer=!1):r===o.Q.enableAlternativeBuffer?this._inAlternativeBuffer=!0:r===o.Q.cursorHome&&(this._writeColumn=0);continue}}else if(void 0!==s){const s=t.slice(e,e+2);n.push(...s),e+=1;continue}}switch(i){case 10:if(0===this._writeColumn&&(s&a.G.OutputFlag.ONOCR)>0)break;this._writeColumn=0,(s&a.G.OutputFlag.ONLCR)>0?n.push(13,10):n.push(10);break;default:!this._inAlternativeBuffer&&i>=32&&this._writeColumn++,n.push(i)}}return n}_readFromBuffer(t){if(null===t){const t=this._readBuffer;return this._readBuffer=[],t}{const e=this._readBuffer.slice(0,t);return this._readBuffer.splice(0,e.length),e}}_available;_enabled=!1;_inAlternativeBuffer=!1;_utf8Decoder;_writeColumn=0;_readBuffer=[]}class h extends c{constructor(t,e,s,n,r){super(t,e),this._utils=new i.F(s,n,r)}_getStdin(t){return this._utils.getStdin(t)}async _getStdinAsync(t){return this._utils.getStdinAsync(t)}_utils}var u=s(763);class d extends c{constructor(t,e,s){super(t,e);const n=u.X.maxChars+4;this._sharedArrayBuffer=s,this._intArray=new Int32Array(this._sharedArrayBuffer,0,n)}_getStdin(t){Atomics.load(this._intArray,u.X.REQUEST_INDEX)!==u.X.NO_REQUEST_VALUE&&console.error("SharedArrayBuffer stdin request already pending"),Atomics.store(this._intArray,u.X.REQUEST_INDEX,u.X.REQUEST_VALUE),Atomics.store(this._intArray,u.X.TIMEOUT_INDEX,u.X.encodeTimeout(t)),Atomics.notify(this._intArray,u.X.REQUEST_INDEX,1),Atomics.wait(this._intArray,u.X.REQUEST_INDEX,u.X.REQUEST_VALUE);const e=Atomics.load(this._intArray,u.X.LENGTH_INDEX);let s="";for(let t=0;t<e;t++)s+=String.fromCharCode(Atomics.load(this._intArray,u.X.START_INDEX+t));return s}async _getStdinAsync(t){Atomics.load(this._intArray,u.X.REQUEST_INDEX)!==u.X.NO_REQUEST_VALUE&&console.error("SharedArrayBuffer stdin request already pending"),Atomics.store(this._intArray,u.X.REQUEST_INDEX,u.X.REQUEST_VALUE),Atomics.store(this._intArray,u.X.TIMEOUT_INDEX,u.X.encodeTimeout(t)),Atomics.notify(this._intArray,u.X.REQUEST_INDEX,1);const{async:e,value:s}=Atomics.waitAsync(this._intArray,u.X.REQUEST_INDEX,u.X.REQUEST_VALUE);e&&await s;const n=Atomics.load(this._intArray,u.X.LENGTH_INDEX);let i="";for(let t=0;t<n;t++)i+=String.fromCharCode(Atomics.load(this._intArray,u.X.START_INDEX+t));return i}_intArray;_sharedArrayBuffer}class m{setMainIO;setWorkerIO;constructor(t,e){this.setMainIO=t,this.setWorkerIO=e,this._map.set("sab",{longName:"shared array buffer",available:!1}),this._map.set("sw",{longName:"service worker",available:!1})}available(t){return this._getByShortName(t).available}get enabled(){return this._enabled}get shortNames(){return Array(...this._map.keys())}longName(t){return this._getByShortName(t).longName}setAvailable(t,e){this._getByShortName(t).available=e}setEnabled(t){if(this._map.has(t))return void this._enable(t);const e=Object.entries(this._map).find(([e,s])=>s.longName===t);if(void 0===e)throw new Error(`Unknown StdinContext name '${t}'`);this._enable(e[0])}_enable(t){if(t!==this._enabled){if(!this._getByShortName(t).available)throw new Error(`StdinContext '${t}' is not available`);this._enabled=t,this._initialised?(this.setWorkerIO(t),this.setMainIO(t)):this._initialised=!0}}_getByShortName(t){const e=this._map.get(t);if(void 0===e)throw new Error(`Unknown shortName '${t}' passed to StdinContext`);return e}_map=new Map;_enabled="";_initialised=!1}var p,_=s(7450);class f{get(t,e){const s=this.key(t,e);return this._cache.get(s)??void 0}has(t,e){const s=this.key(t,e);return this._cache.has(s)}key(t,e){return[t,e].join("/")}set(t,e,s){const n=this.key(t,e);this._cache.set(n,s)}_cache=new Map}class g{wasmBaseUrl;downloadModuleCallback;constructor(t,e){this.wasmBaseUrl=t,this.downloadModuleCallback=e}getJavaScriptModule(t,e){const s=this._getModule(t,e,!1);return void 0!==s?s:void 0}getWasmModule(t,e){const s=this._getModule(t,e,!0);return void 0!==s?s:void 0}_getModule(t,e,s){let n=this.cache.get(t,e);if(void 0===n){const i=this.cache.key(t,e)+".js",r=(0,l.oq)(this.wasmBaseUrl,i);console.log(`Cockle loading ${s?"WebAssembly":"JavaScript"} module from ${r}`),this.downloadModuleCallback(t,e,!0);try{importScripts(r),n=self.Module}finally{this.downloadModuleCallback(t,e,!1)}void 0!==n&&this.cache.set(t,e,n)}return n}cache=new f}!function(t){t[t.None=0]="None",t[t.Unknown=1]="Unknown",t[t.Builtin=2]="Builtin",t[t.External=4]="External",t[t.JavaScript=8]="JavaScript",t[t.Wasm=16]="Wasm",t[t.All=31]="All"}(p||(p={}));var C=s(7095);class w{name;callExternalCommand;callExternalTabComplete;constructor(t,e,s){this.name=t,this.callExternalCommand=e,this.callExternalTabComplete=s}get commandType(){return p.External}get moduleName(){return"<external>"}names(){return[this.name]}get packageName(){return""}async run(t){const{name:e,args:s,environment:n,stdin:i,stdout:r,stderr:o}=t;if(e!==this.name)throw new C.xZ(e);const{exitCode:a,environmentChanges:l}=await this.callExternalCommand(e,s,Object.fromEntries(n),i.isTerminal(),r.isTerminal(),o.isTerminal(),t.termios.get());return void 0!==l&&Object.entries(l).forEach(([t,e])=>{void 0===e?n.delete(t):n.set(t,e)}),a}async tabComplete(t){if(void 0!==this.callExternalTabComplete){const{name:e,args:s}=t;return await this.callExternalTabComplete(e,s)}return{}}}class y{get commandType(){return p.Builtin}get moduleName(){return"<builtin>"}get packageName(){return""}names(){return[this.name]}run(t){const{name:e}=t;if(e!==this.name)throw new C.xZ(e);return this._run(t)}}var S=s(2199),x=s(5874),b=s(3482);class E extends x.k{description="Without arguments, 'alias' prints the list of aliases in the reusable\n    form 'alias NAME=VALUE' on standard output.\n\n    Otherwise, an alias is defined for each NAME whose VALUE is given.\n    A trailing space in VALUE causes the next word to be checked for\n    alias substitution when the alias is expanded.";positional=new S.Tl;help=new S.C8("h","help","display this help and exit")}class k extends y{get name(){return"alias"}async tabComplete(t){return await(new E).tabComplete(t)}async _run(t){const{aliases:e,stdout:s}=t,n=(new E).parse(t.args);if(n.help.isSet)return n.writeHelp(s),b.y.SUCCESS;if(n.positional.isSet)for(const t of n.positional.strings){const n=t.indexOf("=");-1===n?s.write(`${t}='${e.get(t)}'\n`):e.set(t.slice(0,n),t.slice(n+1))}else for(const[t,n]of e.entries())s.write(`${t}='${n}'\n`);return b.y.SUCCESS}}class I extends x.k{help=new S.C8("h","help","display this help and exit")}class O extends I{description="Always succeeds; Return a successful result."}class v extends I{description="Always fails; Return an unsuccessful result."}class N extends y{get name(){return"true"}async tabComplete(t){return await(new O).tabComplete(t)}async _run(t){const e=(new O).parse(t.args);return e.help.isSet?(e.writeHelp(t.stdout),b.y.SUCCESS):b.y.SUCCESS}}class R extends y{get name(){return"false"}async tabComplete(t){return await(new v).tabComplete(t)}async _run(t){const e=(new v).parse(t.args);return e.help.isSet?(e.writeHelp(t.stdout),b.y.SUCCESS):b.y.GENERAL_ERROR}}var T=s(955);class A extends x.k{description='Change the shell working directory.\n  \n  Change the current directory to DIR. If DIR is "-", it is converted to $OLDPWD.';positional=new S.ET({pathType:T.y.Directory});help=new S.C8("h","help","display this help and exit")}class L extends y{get name(){return"cd"}async tabComplete(t){return await(new A).tabComplete(t)}async _run(t){const e=(new A).parse(t.args);if(e.help.isSet)return e.writeHelp(t.stdout),b.y.SUCCESS;const s=e.positional.strings;if(s.length<1)return b.y.SUCCESS;if(s.length>1)throw new C.$g("cd: too many arguments");let n=s[0];if("-"===n){const e=t.environment.get("OLDPWD");if(void 0===e)throw new C.$g("cd: OLDPWD not set");n=e,t.stdout.write(`${n}\n`)}const{FS:i}=t.fileSystem,r=i.cwd();return i.chdir(n),t.environment.set("OLDPWD",r),t.environment.set("PWD",i.cwd()),b.y.SUCCESS}}class B extends x.k{description="Clear the terminal screen if ANSI escapes are supported.";help=new S.C8("h","help","display this help and exit")}class D extends y{get name(){return"clear"}async tabComplete(t){return await(new B).tabComplete(t)}async _run(t){const{stdout:e}=t,s=(new B).parse(t.args);return s.help.isSet?(s.writeHelp(e),b.y.SUCCESS):(e.isTerminal()&&e.write(o.Q.eraseScreen+o.Q.eraseSavedLines+o.Q.cursorHome),b.y.SUCCESS)}}var M=s(585),U=s(3694);class W extends x.s{help=new S.C8("h","help","display this help and exit");builtin=new S.C8("b","builtin","display only builtin commands");external=new S.C8("e","external","display only external commands");javascript=new S.C8("j","javascript","display only javascript commands");wasm=new S.C8("w","wasm","display only wasm commands");positional=new S.Tl({tabComplete:async t=>({possibles:t.commandRegistry?.match(t.args.at(-1)||"",H(this))??[]})})}class F extends x.s{positional=new S.Tl({tabComplete:async t=>({possibles:t.commandRegistry?.allModules().map(t=>t.name)??[]})})}class $ extends x.s{positional=new S.Tl({tabComplete:async t=>({possibles:t.commandRegistry?[...t.commandRegistry.commandPackageMap.keys()]:[]})})}class P extends x.s{positional=new S.Tl({max:1,tabComplete:async t=>({possibles:t.stdinContext?.shortNames??[]})})}class Q extends x.k{description="Inspect and optionally modify Cockle configuration. Without arguments prints all sections. Use subcommands to target specific areas.";version=new S.C8("v","version","show cockle version");help=new S.C8("h","help","display this help and exit");subcommands={command:new W("command","Show information about one or more commands."),module:new F("module","Show information about one or more modules."),package:new $("package","Show information about one or more packages."),stdin:new P("stdin","Configure or show synchronous stdin settings.")}}class X extends y{get name(){return"cockle-config"}async tabComplete(t){return await(new Q).tabComplete(t)}async _run(t){const{environment:e,stdout:s}=t,n=(new Q).parse(t.args),{subcommands:i}=n;if(n.help.isSet)return n.writeHelp(s),b.y.SUCCESS;const r=s.isTerminal()&&e.color?M.Ju.defaultColorByColumn():void 0,o=0===t.args.length;if((o||n.version.isSet)&&this._writeVersion(t),(o||i.stdin.isSet)&&this._writeOrSetSyncStdinConfig(t,r,i.stdin.positional.strings.at(0)),(o||i.package.isSet)&&this._writePackageConfig(t,r,i.package.positional.strings),(o||i.module.isSet)&&this._writeModuleConfig(t,r,i.module.positional.strings),i.command.isSet){const{command:e}=i;if(e.help.isSet)return e.writeHelp(s),b.y.SUCCESS;this._writeCommandConfig(t,r,e)}return b.y.SUCCESS}_writeCommandConfig(t,e,s){const{commandRegistry:n,stdout:i}=t,r=s.positional.strings;let o=n.commandNames(H(s));if(r.length>0){const t=r.filter(t=>!o.includes(t));if(t.length>0)throw new C.$g(`Unknown command(s): ${t.sort().join(" ")}`);o=r.sort()}const a=new M.Ju({colorByColumn:e,sortByColumn:[0]});a.addHeaderRow(["command","module"]);for(const t of o){const e=n.get(t);if(null===e)throw new C.$g(`Unknown command '${t}'`);a.addRow([t,e.moduleName])}a.write(i)}_writeModuleConfig(t,e,s){const{commandRegistry:n,commandModuleCache:i,stdout:r}=t;let o=n.allModules();const a=o.map(t=>t.name);if(s.length>0){const t=s.filter(t=>!a.includes(t));if(t.length>0)throw new C.$g(`Unknown module(s): ${t.sort().join(" ")}`);o=o.filter(t=>s.includes(t.name))}const l=new M.Ju({colorByColumn:e,sortByColumn:[0,1]});l.addHeaderRow(["module","package","cached"]);for(const t of o)l.addRow([t.name,t.packageName,i.has(t.packageName,t.name)?"yes":""]);l.write(r)}_writeOrSetSyncStdinConfig(t,e,s){const{stdinContext:n,stdout:i}=t;void 0!==s&&n.setEnabled(s);const r=new M.Ju({colorByColumn:e});r.addHeaderRow(["synchronous stdin","short name","available","enabled"]);const{enabled:o,shortNames:a}=n;for(const t of a)r.addRow([n.longName(t),t,n.available(t)?"yes":"",o===t?"yes":""]);r.write(i)}_writePackageConfig(t,e,s){const{commandRegistry:n,stdout:i}=t;let r=[...n.commandPackageMap.keys()];if(s.length>0){const t=s.filter(t=>!r.includes(t));if(t.length>0)throw new C.$g(`Unknown package(s): ${t.sort().join(" ")}`);r=s.sort()}const o=new M.Ju({colorByColumn:e,sortByColumn:[0]});o.addHeaderRow(["package","type","version","build string","source"]);for(const t of r){const e=n.commandPackageMap.get(t);o.addRow([e.name,e.wasm?"wasm":"js",e.version,e.build_string,e.channel])}o.write(i)}_writeVersion(t){const{stdout:e}=t;e.write(`cockle ${U.Z}\n`)}}function H(t){let e=p.None;return t.builtin.isSet&&(e|=p.Builtin),t.external.isSet&&(e|=p.External),t.javascript.isSet&&(e|=p.JavaScript),t.wasm.isSet&&(e|=p.Wasm),e===p.None&&(e=p.All),e}class j extends x.k{description="Exit the shell";help=new S.C8("h","help","display this help and exit")}class V extends y{get name(){return"exit"}async tabComplete(t){return await(new j).tabComplete(t)}async _run(t){const{stdout:e,terminate:s}=t,n=(new j).parse(t.args);return n.help.isSet?(n.writeHelp(e),b.y.SUCCESS):(e.write("Terminating shell...\n"),e.flush(),s(),b.y.SUCCESS)}}class G extends x.k{description="Set export attribute for shell variables.\n    \n    Marks each NAME for automatic export to the environment of subsequently\n    executed commands.  If VALUE is supplied, assign VALUE before exporting.";positional=new S.Tl;help=new S.C8("h","help","display this help and exit")}class z extends y{get name(){return"export"}async tabComplete(t){return await(new G).tabComplete(t)}async _run(t){const{environment:e,stdout:s}=t,n=(new G).parse(t.args);if(n.help.isSet)return n.writeHelp(s),b.y.SUCCESS;if(n.positional.isSet)for(const t of n.positional.strings){const s=t.indexOf("=");if(s>0){const n=t.slice(0,s),i=t.slice(s+1);e.set(n,i)}}return b.y.SUCCESS}}class q extends x.k{description="Show help for built-in commands. With no arguments, lists available builtins. With names, shows each command's help (equivalent to '<cmd> --help').";help=new S.C8("h","help","display this help and exit");positional=new S.Tl({tabComplete:async t=>({possibles:t.commandRegistry?.commandNames(p.Builtin)??[]})})}class Y extends y{get name(){return"help"}async tabComplete(t){return await(new q).tabComplete(t)}async _run(t){const{args:e,stdout:s,stderr:n,commandRegistry:i}=t,r=(new q).parse(e);if(r.help.isSet)return r.writeHelp(s),b.y.SUCCESS;const o=r.positional.strings,a=i?i.commandNames(p.Builtin):[];if(0===o.length){s.write("Built-in commands:\n");for(const t of a)s.write(`  ${t}\n`);return s.write("\n"),s.write("For detailed help, type <command-name> --help (e.g., `history --help` or `alias -h`)."),b.y.SUCCESS}let l=b.y.SUCCESS;for(const e of o){if(!a.includes(e)){n.write(`help: unknown built-in: ${e}\n`),l=b.y.GENERAL_ERROR;continue}const r=i.get(e);if(null===r){n.write(`help: failed to get command '${e}'\n`),l=b.y.GENERAL_ERROR;continue}const o={...t,name:e,args:["--help"]};s.write(`\n=== help for ${e} ===\n`),await r.run(o)}return l}}class J extends x.k{description=" Display or manipulate the history list.\n\n    Display the history list with line numbers, prefixing each modified\n    entry with a '*'";clear=new S.C8("c","","clear the history by deleting all of the entries");help=new S.C8("h","help","display this help and exit")}class K extends y{get name(){return"history"}async tabComplete(t){return await(new J).tabComplete(t)}async _run(t){const{history:e,stdout:s}=t,n=(new J).parse(t.args);return n.help.isSet?n.writeHelp(s):n.clear.isSet?e.clear():e.write(s),b.y.SUCCESS}}class Z extends x.k{description="Locate built-in commands by name. Prints each given command if it exists, otherwise an error message.";help=new S.C8("h","help","display this help and exit");positional=new S.Tl({tabComplete:async t=>({possibles:t.commandRegistry?.commandNames()??[]})})}class tt extends y{get name(){return"which"}async tabComplete(t){return await(new Z).tabComplete(t)}async _run(t){const{args:e,stdout:s}=t,n=new Set(t.commandRegistry?.commandNames()),i=(new Z).parse(t.args);if(i.help.isSet)return i.writeHelp(s),b.y.SUCCESS;if(0===i.positional.strings.length)return s.write("which: missing operand\n"),i.writeHelp(s),b.y.GENERAL_ERROR;let r=b.y.SUCCESS;for(const s of e)n.has(s)?t.stdout.write(`${s}\n`):(t.stdout.write(`which: no ${s} command\n`),r=b.y.GENERAL_ERROR);return r}}class et{callExternalCommand;callExternalTabComplete;constructor(t,e){this.callExternalCommand=t,this.callExternalTabComplete=e,this.registerBuiltinCommands(n)}allModules(){const t=[];for(const e of this.commandPackageMap.values())t.push(...e.modules);return t.sort((t,e)=>t.name<e.name?-1:1),t}commandNames(t=p.All){return t===p.None?[]:t===p.All?Array.from(this._map.keys()).sort():Array.from(this._map).filter(([e,s])=>(s.commandType&t)>0).map(([t,e])=>t).sort()}get(t){return this._map.get(t)??null}match(t,e=p.All){return this.commandNames(e).filter(e=>e.startsWith(t))}registerBuiltinCommands(t){for(const[e,s]of Object.entries(t))if(e.endsWith("Command")&&!e.startsWith("Builtin"))try{const t=new s;t instanceof y&&this._register(t)}catch{}}registerCommandPackage(t){this.commandPackageMap.set(t.name,t);for(const e of t.modules)this._register(e.runner)}registerExternalCommand(t,e){this._map.set(t,new w(t,this.callExternalCommand,e?this.callExternalTabComplete:void 0))}_register(t){for(const e of t.names())this._map.set(e,t)}_map=new Map;commandPackageMap=new Map}class st{module;constructor(t){this.module=t}get moduleName(){return this.module.moduleName}names(){return this.module.names}get packageName(){return this.module.packageName}}var nt=s(1203);class it extends st{module;constructor(t){super(t),this.module=t}get commandType(){return p.JavaScript}async run(t){const{name:e}=t,s=this.module.loader.getJavaScriptModule(this.packageName,this.moduleName);if(void 0===s)throw new C.xZ(e);if(!Object.prototype.hasOwnProperty.call(s,"run"))throw new C.C2(e);const{args:n,environment:i,fileSystem:r,shellId:o,stdout:a,stderr:l,termios:c,size:h}=t,u={name:e,args:n,environment:i,fileSystem:r,shellId:o,stdin:new nt._(t.stdin),stdout:a,stderr:l,size:h,termios:c};try{return await s.run(u)}catch(t){throw console.error(`JavascriptCommandRunner: ${t}`),new C.T6(e)}}async tabComplete(t){const e=this.module.loader.getJavaScriptModule(this.packageName,this.moduleName);if(void 0!==e&&Object.prototype.hasOwnProperty.call(e,"tabComplete")&&void 0!==e.tabComplete){const{name:s,args:n,shellId:i}=t;try{return await e.tabComplete({name:s,args:n,shellId:i})}catch(t){}}return{}}}class rt extends st{module;constructor(t){super(t),this.module=t}get commandType(){return p.Wasm}async run(t){const{name:e,args:s,workerIO:n,fileSystem:i,stdin:r,stdout:o,stderr:a,termios:c,size:h}=t,{wasmBaseUrl:u}=this.module.loader,d=Date.now(),m=this.module.loader.getWasmModule(this.packageName,this.moduleName);if(void 0===m)throw new C.xZ(e);function p(t){return c.get()}function _(t,e,s){return c.set(s),0}function f(t){return h()}function g(t,e){return n.poll(e)}function w(t,e,s,n,i){if(0===n)return 0;let o=r.read(n);return 1===o.length&&4===o[0]&&(o=[]),e.set(o,s),o.length}function y(t,i,r,l,c){if(0===l)return 0;const h=i.slice(r,r+l),u=n.utf8ArrayToString(h),d="/dev/tty1"===t.path;return d&&"touch"===e&&s.length>1||(d?a:o).write(u),l}let S;function x(t){void 0===S&&(S=t)}const E=await m({thisProgram:e,arguments:s,locateFile:t=>(0,l.oq)(u,this.packageName+"/"+t),onExit:t=>x(t),quit:(t,e)=>x(t),preRun:[e=>{if(Object.prototype.hasOwnProperty.call(e,"FS")){const t=e.FS,{mountpoint:s}=i;t.mkdir(s,511),t.mount(i.PROXYFS,{root:s,fs:i.FS},s),t.chdir(i.FS.cwd())}Object.prototype.hasOwnProperty.call(e,"ENV")&&t.environment.copyIntoCommand(e.ENV,o.isTerminal()),Object.prototype.hasOwnProperty.call(e,"TTY")&&(e.TTY.default_tty_ops.ioctl_tcgets=p,e.TTY.default_tty_ops.ioctl_tcsets=_,e.TTY.default_tty_ops.ioctl_tiocgwinsz=f,e.TTY.stream_ops.poll=g,e.TTY.stream_ops.read=w,e.TTY.stream_ops.write=y)}],stderr:this._outputHandler(a),stdout:this._outputHandler(o)});if(void 0===S)S=b.y.CANNOT_RUN_COMMAND;else if(Object.prototype.hasOwnProperty.call(E,"FS")){const t=E.FS;for(const e of[t.streams[1],t.streams[2]])null===e||t.isClosed(e)||t.close(e)}const k=Date.now();return console.debug(`Cockle ${e} load and run time ${k-d} ms`),S}_outputHandler(t){if(!t.isTerminal())return e=>t.write(String.fromCharCode(e))}}class ot{commandModuleLoader;name;commands;packageName;wasm;constructor(t,e,s,n,i){this.commandModuleLoader=t,this.name=e,this.commands=s,this.packageName=n,this.wasm=i}get loader(){return this.commandModuleLoader}get runner(){return void 0===this._runner&&(this._runner=this.wasm?new rt(this):new it(this)),this._runner}get moduleName(){return this.name}get names(){return this.commands}_runner}class at{name;version;build_string;channel;platform;wasm;modules;constructor(t,e,s,n,i,r,o){this.name=t,this.version=e,this.build_string=s,this.channel=n,this.platform=i,this.wasm=r,this.modules=o}}class lt extends Map{constructor(t){super(),t?(this.set("PS1",o.Q.styleGreen+"js-shell:"+o.Q.styleReset+" "),this.set("TERM","xterm-256color"),this.set("TERMINFO","/usr/local/share/terminfo")):this.set("PS1","js-shell: ")}copyIntoCommand(t,e){for(const[s,n]of this.entries())(e||"TERM"!==s)&&(t[s]=n)}getNumber(t){const e=this.get(t);if(null===e)return null;const s=Number(e);return isNaN(s)?null:s}getPrompt(){return this.get("PS1")??"$ "}get color(){return this.has("TERM")}setSize(t,e){if(t>=1){const e=t.toString();this.set("LINES",e),this.set("LESS_LINES",e)}else this.delete("LINES"),this.delete("LESS_LINES");if(e>=1){const t=e.toString();this.set("COLUMNS",t),this.set("LESS_COLUMNS",t)}else this.delete("COLUMNS"),this.delete("LESS_COLUMNS")}}class ct{add(t){this._current=null,!t.trim()||this._ignoreInitialWhitespace&&t.startsWith(" ")||this._ignoreDuplicates&&t===this.at(-1)||(this._history.length>=this._maxSize&&this._history.shift(),this._history.push(t))}at(t){return this._history.at(t)??null}clear(){this._current=null,this._history=[]}scrollCurrent(t){return this._current=t?null===this._current?null:this._current+1:null===this._current?this._history.length-1:this._current-1,null!==this._current&&(this._current<0?this._current=0:this._current>=this._history.length&&(this._current=null)),null===this._current?null:this.at(this._current)}setMaxSize(t){this._maxSize=Math.max(t,0),this._history.length>this._maxSize&&(this._current=null,this._history=this._history.slice(this._maxSize))}write(t){for(let e=0;e<this._history.length;e++){const s=String(e).padStart(5," ");t.write(`${s}  ${this._history[e]}\n`)}}_history=[];_current=null;_ignoreInitialWhitespace=!0;_ignoreDuplicates=!0;_maxSize=1e3}var ht,ut=s(7703),dt=s(8316),mt=s(4207),pt=s(5981),_t=s(2958),ft=s(312),gt=s(2251),Ct=s(7497);class wt{context;constructor(t){this.context=t}async complete(t){const e=t.text.slice(0,t.cursorIndex),s=t.text.slice(t.cursorIndex),n=(0,Ct.qg)(e,!1).at(-1),[i,r]=e.endsWith(" ")?[null,!1]:void 0!==n?n.lastToken():[null,!0];let a=i?.value??"",c={pathType:T.y.Any};if(r)c={possibles:this._getPossibleCompletionsCommand(a)};else if(n instanceof Ct.Sv){const t=n,e=t.name.value,s=this.context.commandRegistry.get(e);if(null!==s&&void 0!==s.tabComplete){const n=t.suffix.map(t=>t.value);a||n.push("");const{commandRegistry:i,stdinContext:r}=this.context;c=await s.tabComplete({name:e,args:n,commandRegistry:i,shellId:this.context.shellId,stdinContext:r})}}const h=c.possibles??[];if(void 0!==c.pathType){let e=[];[t,a,e]=this._getPossibleCompletionsFileSystem(t,a,c.pathType),h.push(...e)}if(0===h.length)return t;if(h.sort(),1===h.length){let e=h[0].slice(a.length);return e.endsWith("/")||(e+=" "),t.text=t.text.slice(0,t.cursorIndex)+e+s,t.cursorIndex+=e.length,this.context.workerIO.write(e+s+o.Q.cursorLeft(s.length)),t}const u=(0,l.Il)(h,a.length);if(u.length>a.length){const e=u.slice(a.length);return t.text=t.text.slice(0,t.cursorIndex)+e+s,t.cursorIndex+=e.length,this.context.workerIO.write(e+s+o.Q.cursorLeft(s.length)),t}return await this._showPossibleCompletions(t,s,h),t}_getPossibleCompletionsCommand(t){const e=this.context.commandRegistry.match(t),s=this.context.aliases.match(t);return[...new Set([...e,...s])]}_getPossibleCompletionsFileSystem(t,e,s){const{FS:n,PATH:i}=this.context.fileSystem;e||(e="./");const r=e.endsWith("/"),o=[void 0,"/"],a=e.endsWith("..")&&o.includes(e.at(-3)),l=!a&&e.endsWith(".")&&o.includes(e.at(-2)),c=l||a;a&&(e=e.slice(0,-1));const h=n.analyzePath(e,!0),u=r||c?h.path:h.parentPath,d=c?l?".":"..":r?"":h.name;let m=n.readdir(u);r&&(m=m.filter(t=>!t.startsWith("."))),m=m.filter(t=>t.startsWith(d));const p=new yt(n);return s===T.y.Directory?m=m.filter(t=>p.isDir(i.join(u,t))):s===T.y.File&&(m=m.filter(t=>p.isFile(i.join(u,t)))),s!==T.y.File&&(m=m.map(t=>p.isDir(i.join(u,t))?t+"/":t)),[t,d,m]}async _showPossibleCompletions(t,e,s){const{environment:n}=this.context,i=`\n${(0,l.tp)(s,n.getNumber("COLUMNS")??0).join("\n")}\n${n.getPrompt()}${t.text}`;this.context.workerIO.write(i+o.Q.cursorLeft(e.length))}}class yt{FS;constructor(t){this.FS=t}isDir(t){return this.FS.isDir(this._stat(t).mode)}isFile(t){return this.FS.isFile(this._stat(t).mode)}_stat(t){let e=this._statCache.get(t);return void 0===e&&(e=this.FS.stat(t,!1),this._statCache.set(t,e)),e}_statCache=new Map}class St{constructor(t){this._options=t,this._commandModuleLoader=new g(t.wasmBaseUrl,t.downloadModuleCallback),this._fileSystem={FS:void 0,PATH:void 0,ERRNO_CODES:void 0,PROXYFS:void 0,mountpoint:t.mountpoint??"/drive"};const e=t.workerIO;this._runContext={name:"",args:[],fileSystem:this._fileSystem,aliases:new _.D,commandRegistry:new et(t.callExternalCommand,t.callExternalTabComplete),environment:new lt(t.color),history:new ct,shellId:t.shellId,terminate:this.terminate.bind(this),stdin:this._dummyInput,stdout:this._dummyOutput,stderr:this._dummyOutput,size:()=>this.size,termios:t.termios,workerIO:e,commandModuleCache:this._commandModuleLoader.cache,stdinContext:t.stdinContext},Object.entries(t.aliases).forEach(([t,e])=>this._runContext.aliases.set(t,e)),Object.entries(t.environment).forEach(([t,e])=>{void 0===e?this._runContext.environment.delete(t):this._runContext.environment.set(t,e)}),t.externalCommandConfigs.forEach(t=>this._runContext.commandRegistry.registerExternalCommand(t.name,t.hasTabComplete)),this._stderr=new ut.m(this.output.bind(this),this._options.color?o.Q.styleRed:void 0,this._options.color?o.Q.styleReset:void 0),this._tabCompleter=new wt(this._runContext)}get aliases(){return this._runContext.aliases}get environment(){return this._runContext.environment}get exitCode(){return this._exitCode}async externalInput(t){const e=await this._runContext.stdin.readAsync(t);return String.fromCharCode(...e)}externalOutput(t,e){(e?this._runContext.stderr:this._runContext.stdout).write(t)}get history(){return this._runContext.history}async initialize(){await this._initWasmPackages(),await this._initFileSystem()}async input(t){if(!this._isRunning)return;const e=t.length;for(let s=0;s<e;++s){const e=t[s];switch(e.charCodeAt(0)){case 13:{this.output("\n");const t=this._commandLine.text;this._commandLine.text="",this._commandLine.cursorIndex=0,t.length>0&&await this._runCommands(t),await this._outputPrompt();break}case 127:if(this._commandLine.cursorIndex>0){const{cursorIndex:t,text:e}=this._commandLine,s=e.slice(t);this._commandLine.text=e.slice(0,t-1)+s,this._commandLine.cursorIndex--,this.output(o.Q.cursorLeft(1)+s+o.Q.eraseEndLine+o.Q.cursorLeft(s.length))}break;case 9:this._commandLine=await this._tabCompleter.complete(this._commandLine);break;case 27:s+=this._escapedInput(t,s);break;case 4:break;default:if(this._commandLine.cursorIndex===this._commandLine.text.length)this._commandLine.text+=e,this.output(e);else{const{cursorIndex:t,text:s}=this._commandLine,n=s.slice(t);this._commandLine.text=s.slice(0,t)+e+n,this.output(o.Q.eraseEndLine+e+n+o.Q.cursorLeft(n.length))}this._commandLine.cursorIndex++}}}output(t){this._isRunning&&this._runContext.workerIO.write(t)}setSize(t,e){this._size=[t,e],this.environment.setSize(t,e)}setWorkerIO(t){this._runContext.workerIO=t}get size(){return this._size}async start(){this._isRunning=!0,await this._outputPrompt()}terminate(){console.log("Cockle ShellImpl.terminate"),this._isRunning=!1,this._options.terminateCallback()}async themeChange(t){this._requestedDarkMode=t,this._themeStatus===ht.Ok&&(this._themeStatus=ht.PendingChange,this._runContext.workerIO.enabled||await this._handleThemeChange())}_escapedInput(t,e){if("["!==t.at(e+1))return 0;const s=/^[^A-Z~]*[A-Z~]/.exec(t.slice(e+2));if(null===s)return 1;const n=s[0];switch(n){case"A":case"1A":case"B":case"1B":{const t=this.history.scrollCurrent(n.endsWith("B"));this._commandLine.text=null!==t?t:"",this._commandLine.cursorIndex=this._commandLine.text.length,this.output(o.Q.eraseEndLine+o.Q.eraseStartLine+`\r${this.environment.getPrompt()}${this._commandLine.text}`);break}case"D":case"1D":this._commandLine.cursorIndex>0&&(this._commandLine.cursorIndex--,this.output(o.Q.cursorLeft()));break;case"C":case"1C":this._commandLine.cursorIndex<this._commandLine.text.length&&(this._commandLine.cursorIndex++,this.output(o.Q.cursorRight()));break;case"3~":if(this._commandLine.cursorIndex<this._commandLine.text.length){const{cursorIndex:t,text:e}=this._commandLine,s=e.slice(t+1);this._commandLine.text=e.slice(0,t)+s,this.output(o.Q.eraseEndLine+s+o.Q.cursorLeft(s.length))}break;case"H":case"1;2H":this._commandLine.cursorIndex>0&&(this.output(o.Q.cursorLeft(this._commandLine.cursorIndex)),this._commandLine.cursorIndex=0);break;case"F":case"1;2F":{const{length:t}=this._commandLine.text;this._commandLine.cursorIndex<t&&(this.output(o.Q.cursorRight(t-this._commandLine.cursorIndex)),this._commandLine.cursorIndex=t);break}case"1;2D":case"1;5D":if(this._commandLine.cursorIndex>0){const{cursorIndex:t,text:e}=this._commandLine,s=e.slice(0,t).trimEnd().lastIndexOf(" ")+1;this.output(o.Q.cursorLeft(t-s)),this._commandLine.cursorIndex=s}break;case"1;2C":case"1;5C":{const{length:t}=this._commandLine.text;if(this._commandLine.cursorIndex<t-1){const{cursorIndex:e,text:s}=this._commandLine,n=s.slice(e),i=n.trimStart(),r=i.indexOf(" "),a=r<0?t:e+n.length-i.length+r;this.output(o.Q.cursorRight(a-e)),this._commandLine.cursorIndex=a}break}default:console.warn(`Unrecognised escape sequence '[${n}'`)}return n.length+1}_filenameExpansion(t){const{PATH:e}=this._runContext.fileSystem;let s=[],n=0;for(const i of t){if(i.startsWith("-")){n++,s.push(i);continue}if(!i.includes("*")&&!i.includes("?")){s.push(i);continue}const{FS:t}=this._runContext.fileSystem,r=t.analyzePath(i,!1);if(!r.parentExists){s.push(i);continue}const o=r.parentPath;let a=o;const l=t.cwd();a.startsWith(l)&&(a=a.slice(l.length),a.startsWith("/")&&(a=a.slice(1)));let c=t.readdir(o),h=r.name.replace(/[.+^${}()|[\]\\]/g,"\\$&");h=h.replaceAll("*",".*"),h=h.replaceAll("?",".");const u=new RegExp(`^${h}$`);c=c.filter(t=>t.match(u)),c=c.filter(t=>!t.startsWith(".")),a.length>0&&(c=c.map(t=>e.join(a,t))),s=s.concat(c)}return s.length===n&&(s=t),s}async _handleThemeChange(){if(this._themeStatus===ht.Changing)return;if(void 0!==this._requestedDarkMode)return void this._setDarkMode(this._requestedDarkMode);this._themeStatus=ht.Changing,await this._options.enableBufferedStdinCallback(!0);const{termios:t,workerIO:e}=this._options;t.setRawMode(),this.output("]11;?");const s=Date.now(),n=await e.readAsync(null,100);console.debug("Cockle theme change",Date.now()-s,"ms"),t.setDefaultShell(),await this._options.enableBufferedStdinCallback(!1),this._themeStatus=ht.Ok;const i=String.fromCharCode(...n),r=/^\x1b]11;rgb:([0-9A-Fa-f]{2,})\/([0-9A-Fa-f]{2,})\/([0-9A-Fa-f]{2,})\x1b\\$/.exec(i);if(r){const t=(parseInt(r[1].slice(0,2),16)/255+parseInt(r[2].slice(0,2),16)/255+parseInt(r[3].slice(0,2),16)/255)/3;this._setDarkMode(t<.6)}else console.warn("Unable to determine terminal background color"),this._setDarkMode(void 0)}async _initFileSystem(){const{wasmBaseUrl:t}=this._options,e=this._commandModuleLoader.getWasmModule("cockle_fs","fs");if(void 0===e)return void console.error("Unable to load cockle_fs, shell cannot function");const s=await e({locateFile:e=>(0,l.oq)(t,"cockle_fs/"+e)}),{FS:n,PATH:i,ERRNO_CODES:r,PROXYFS:o}=s,a=this._fileSystem.mountpoint;n.mkdirTree(a,511),this._runContext.fileSystem.FS=n,this._runContext.fileSystem.PATH=i,this._runContext.fileSystem.ERRNO_CODES=r,this._runContext.fileSystem.PROXYFS=o;const{browsingContextId:c,baseUrl:h,initialDirectories:u,initialFiles:d}=this._options;this._options.initDriveFSCallback({browsingContextId:c,baseUrl:h,fileSystem:this._runContext.fileSystem,mountpoint:a}),n.chdir(a),this.environment.set("PWD",n.cwd()),u&&u.forEach(t=>n.mkdir(t,509)),d&&Object.entries(d).forEach(([t,e])=>n.writeFile(t,e,{mode:436}))}async _initWasmPackages(){const t=(0,l.oq)(this._options.wasmBaseUrl,"cockle-config.json"),e=await fetch(t);e.ok||console.error(`Failed to fetch ${t}, terminal cannot function without it`);const s=await e.json(),n=Object.keys(s.packages),i="cockle_fs";n.includes(i)||console.error(`cockle-config.json does not include required package '${i}'`);for(const t of n){const e=s.packages[t],n=Object.entries(e.modules).map(([s,n])=>new ot(this._commandModuleLoader,s,n.commands?n.commands.split(","):[],t,e.wasm)),i=new at(t,e.version,e.build_string,e.channel,e.platform,e.wasm,n);this._runContext.commandRegistry.registerCommandPackage(i)}if(Object.hasOwn(s,"aliases"))for(const[t,e]of Object.entries(s.aliases)){const s=e;s.length>0&&this.aliases.set(t,s)}if(Object.hasOwn(s,"environment"))for(const[t,e]of Object.entries(s.environment)){const s=e;s.length>0&&this.environment.set(t,s)}}async _outputPrompt(){this._isRunning&&(this._themeStatus===ht.PendingChange&&await this._handleThemeChange(),this._runContext.workerIO.write(`\n${this.environment.getPrompt()}`))}async _runCommands(t){if(t.startsWith("!")){const e=parseInt(t.slice(1)),s=this.history.at(e);if(null===s){let t="!"+e+": event not found";return this._options.color&&(t=o.Q.styleBoldRed+t+o.Q.styleReset),this.output(`${t}\n`),void await this._outputPrompt()}t=s}let e;await this._options.enableBufferedStdinCallback(!0),this._options.termios.setDefaultWasm(),this.history.add(t);const s=new dt.d(this._stdinCallback.bind(this),this._stdinAsyncCallback.bind(this)),n=new ut.m(this.output.bind(this)),i=this._stderr;try{const r=(0,Ct.qg)(t,!0,this.aliases);for(const t of r)if(t instanceof Ct.Sv)e=await this._runCommand(t,s,n,i);else{if(!(t instanceof Ct.Ru))throw new C.$g(`Expected CommandNode or PipeNode not ${t}`);{const{commands:e}=t,r=e.length;let o;for(let t=0;t<r;t++){const a=0===t?s:o.input,l=t<r-1?o=new mt.n:n;await this._runCommand(e[t],a,l,i)}}}}catch(t){t instanceof C.Ge&&(e=t.exitCode),i.write(t+"\n"),i.flush()}finally{e=e??b.y.GENERAL_ERROR,this._setExitCode(e),this._options.termios.setDefaultShell(),await this._options.enableBufferedStdinCallback(!1)}}async _runCommand(t,e,s,n){const i=t.name.value,r=this._runContext.commandRegistry.get(i);if(null===r)throw new C.xZ(i);if(t.redirects){if(t.redirects.length>1)throw new C.$g("Only implemented a single redirect per command");const n=t.redirects[0],i=n.token.value,r=n.target.value;if(">"===i||">>"===i)s=new pt.M(this._runContext.fileSystem,r,">>"===i);else{if("<"!==i)throw new C.$g("Unrecognised redirect "+i);e=new _t.z(this._runContext.fileSystem,r)}}let o=t.suffix.map(t=>t.value);o=this._filenameExpansion(o),this._runContext.name=i,this._runContext.args=o,this._runContext.stdin=e,this._runContext.stdout=s,this._runContext.stderr=n;let a=-1;try{a=await r.run(this._runContext)}finally{n.flush(),s.flush(),this._runContext.name="",this._runContext.args=[],this._runContext.stdin=this._dummyInput,this._runContext.stdout=this._dummyOutput,this._runContext.stderr=this._dummyOutput}return a}_setDarkMode(t){if(t===this._darkMode)return;if(this._darkMode=t,this._options.color){this._stderr.prefix=t?o.Q.styleBrightRed:o.Q.styleRed;const e=t?o.Q.styleBoldGreen:o.Q.styleGreen;this._runContext.environment.set("PS1",e+"js-shell:"+o.Q.styleReset+" ")}const e="COCKLE_DARK_MODE";void 0===t?this.environment.delete(e):this.environment.set(e,t?"1":"0")}_setExitCode(t){this._exitCode=t,this.environment.set("?",`${t}`)}_stdinCallback(t){return this._runContext.workerIO.read(t)}async _stdinAsyncCallback(t){return await this._runContext.workerIO.readAsync(t,-1)}_commandLine={text:"",cursorIndex:0};_darkMode;_exitCode=0;_requestedDarkMode;_isRunning=!1;_size=[0,0];_themeStatus=ht.PendingChange;_commandModuleLoader;_runContext;_dummyInput=new ft.X;_dummyOutput=new gt.y;_fileSystem;_options;_stderr;_tabCompleter}!function(t){t[t.Ok=0]="Ok",t[t.PendingChange=1]="PendingChange",t[t.Changing=2]="Changing"}(ht||(ht={}));class xt{async initialize(t,e,s,n,i,r,o,a){if(this._stdinContext=new m(o,this._setWorkerIO.bind(this)),t.supportsServiceWorker&&(this._serviceWorkerWorkerIO=new h(r,this._termios,t.baseUrl??"",t.browsingContextId??"",t.shellId),this._stdinContext.setAvailable("sw",!0)),void 0!==t.sharedArrayBuffer&&(this._sharedArrayBufferWorkerIO=new d(r,this._termios,t.sharedArrayBuffer),this._stdinContext.setAvailable("sab",!0)),this._workerIO=this._sharedArrayBufferWorkerIO??this._serviceWorkerWorkerIO,void 0===this._workerIO)throw new Error("ABORT: does not support SharedArrayBuffer or ServiceWorker!");this._stdinContext.setEnabled(this._workerIO===this._sharedArrayBufferWorkerIO?"sab":"sw"),this._downloadModuleCallback=n,this._enableBufferedStdinCallback=i,this._terminateCallback=a,this._shellImpl=new St({shellId:t.shellId,color:t.color,mountpoint:t.mountpoint,baseUrl:t.baseUrl,wasmBaseUrl:t.wasmBaseUrl,browsingContextId:t.browsingContextId,aliases:t.aliases,environment:t.environment,externalCommandConfigs:t.externalCommandConfigs,initialDirectories:t.initialDirectories,initialFiles:t.initialFiles,callExternalCommand:e,callExternalTabComplete:s,downloadModuleCallback:this._downloadModuleCallback.bind(this),enableBufferedStdinCallback:this.enableBufferedStdin.bind(this),initDriveFSCallback:this.initDriveFS.bind(this),terminateCallback:this._terminateCallback.bind(this),workerIO:this._workerIO,stdinContext:this._stdinContext,termios:this._termios}),await this._shellImpl.initialize()}async enableBufferedStdin(t){t?(await(this._workerIO?.canEnable()),this._enableBufferedStdinCallback&&await this._enableBufferedStdinCallback(!0),await(this._workerIO?.enable())):(this._enableBufferedStdinCallback&&await this._enableBufferedStdinCallback(!1),await(this._workerIO?.disable()))}get exitCode(){return this._shellImpl?.exitCode??1}async externalInput(t){return this._shellImpl.externalInput(t)}externalOutput(t,e){this._shellImpl?.externalOutput(t,e)}externalSetTermios(t){this._termios.set(t)}async input(t){this._shellImpl&&await this._shellImpl.input(t)}setSize(t,e){this._shellImpl&&this._shellImpl.setSize(t,e)}async start(){this._shellImpl&&await this._shellImpl.start()}async themeChange(t){await(this._shellImpl?.themeChange(t))}_setWorkerIO(t){const e=this._workerIO;if("sab"===t&&void 0!==this._sharedArrayBufferWorkerIO)this._workerIO=this._sharedArrayBufferWorkerIO;else{if("sw"!==t||void 0===this._serviceWorkerWorkerIO)throw new Error(`Cannot set WorkerIO to '${t}'`);this._workerIO=this._serviceWorkerWorkerIO}e?.disable(),this._shellImpl?.setWorkerIO(this._workerIO)}_shellImpl;_downloadModuleCallback;_enableBufferedStdinCallback;_terminateCallback;_stdinContext;_serviceWorkerWorkerIO;_sharedArrayBufferWorkerIO;_termios=new a.G.Termios;_workerIO}},763:(t,e,s)=>{var n;s.d(e,{X:()=>n}),function(t){t.REQUEST_INDEX=0,t.TIMEOUT_INDEX=1,t.LENGTH_INDEX=2,t.START_INDEX=3,t.NO_REQUEST_VALUE=0,t.REQUEST_VALUE=1,t.ABORT_VALUE=2,t.maxChars=64;const e=1e5;t.encodeTimeout=function(t){return t<0||t>=e?e:Math.round(t)},t.decodeTimeout=function(t){return t>=e?-1:t}}(n||(n={}))},952:(t,e,s)=>{s.d(e,{J:()=>i});var n=s(1315);class i extends n.S{pipe;constructor(t){super(),this.pipe=t}readAll(){const t=this.pipe.allContent;return this.pipe.clear(),t}}},955:(t,e,s)=>{var n;s.d(e,{y:()=>n}),function(t){t[t.Any=0]="Any",t[t.Directory=1]="Directory",t[t.File=2]="File"}(n||(n={}))},1203:(t,e,s)=>{s.d(e,{_:()=>n});class n{input;constructor(t){this.input=t}isTerminal(){return this.input.isTerminal()}async readAsync(t){const e=await this.input.readAsync(t);return String.fromCharCode(...e)}}},1315:(t,e,s)=>{s.d(e,{S:()=>n});class n{isTerminal(){return!1}async readAsync(t){return this.read(t)}read(t){if(void 0===this._buffer&&(this._buffer=this.readAll(),this._index=0),this._index<this._buffer.length){const t=this._buffer[this._index++],e=[];for(let s=0;s<t.length;s++)e.push(t.charCodeAt(s));return e}return[]}_buffer;_index=0}},2251:(t,e,s)=>{s.d(e,{y:()=>n});class n{flush(){}isTerminal(){return!1}supportsAnsiEscapes(){return!1}write(t){}}},2958:(t,e,s)=>{s.d(e,{z:()=>i});var n=s(1315);class i extends n.S{fileSystem;path;constructor(t,e){super(),this.fileSystem=t,this.path=e}readAll(){const{FS:t}=this.fileSystem;return t.readFile(this.path,{encoding:"utf8"})}}},3482:(t,e,s)=>{s.d(e,{y:()=>n});const n={SUCCESS:0,GENERAL_ERROR:1,IMPROPER_USE:2,CANNOT_RUN_COMMAND:126,CANNOT_FIND_COMMAND:127}},3694:(t,e,s)=>{s.d(e,{Z:()=>n});const n="1.3.0"},4133:(t,e,s)=>{var n;s.d(e,{G:()=>n}),function(t){let e,s,n,i;!function(t){t[t.ISTRIP=32]="ISTRIP",t[t.INLCR=64]="INLCR",t[t.IGNCR=128]="IGNCR",t[t.ICRNL=256]="ICRNL",t[t.IUCLC=512]="IUCLC",t[t.IXON=1024]="IXON",t[t.IXANY=2048]="IXANY",t[t.IMAXBEL=8192]="IMAXBEL",t[t.IUTF8=16384]="IUTF8"}(e=t.InputFlag||(t.InputFlag={})),function(t){t[t.OPOST=1]="OPOST",t[t.OLCUC=2]="OLCUC",t[t.ONLCR=4]="ONLCR",t[t.OCRNL=8]="OCRNL",t[t.ONOCR=16]="ONOCR",t[t.ONLRET=32]="ONLRET",t[t.TABDLY=6144]="TABDLY"}(s=t.OutputFlag||(t.OutputFlag={})),function(t){t[t.ISIG=1]="ISIG",t[t.ICANON=2]="ICANON",t[t.ECHO=8]="ECHO",t[t.ECHOE=16]="ECHOE",t[t.ECHOK=32]="ECHOK",t[t.ECHONL=64]="ECHONL",t[t.NOFLSH=128]="NOFLSH",t[t.ECHOCTL=512]="ECHOCTL",t[t.ECHOPRT=1024]="ECHOPRT",t[t.ECHOKE=2048]="ECHOKE",t[t.IEXTEN=32768]="IEXTEN"}(n=t.LocalFlag||(t.LocalFlag={})),function(t){t[t.VINTR=0]="VINTR",t[t.VQUIT=1]="VQUIT",t[t.VERASE=2]="VERASE",t[t.VKILL=3]="VKILL",t[t.VEOF=4]="VEOF",t[t.VTIME=5]="VTIME",t[t.VMIN=6]="VMIN",t[t.VSWTCH=7]="VSWTCH",t[t.VSTART=8]="VSTART",t[t.VSTOP=9]="VSTOP",t[t.VSUSP=10]="VSUSP",t[t.VEOL=11]="VEOL",t[t.VREPRINT=12]="VREPRINT",t[t.VDISCARD=13]="VDISCARD",t[t.VWERASE=14]="VWERASE",t[t.VLNEXT=15]="VLNEXT",t[t.VEOL2=16]="VEOL2"}(i=t.ControlCharacter||(t.ControlCharacter={})),t.cloneFlags=function(t){return{c_iflag:t.c_iflag,c_oflag:t.c_oflag,c_cflag:t.c_cflag,c_lflag:t.c_lflag,c_cc:[...t.c_cc]}};class r{c_iflag=0;c_oflag=0;c_cflag=0;c_lflag=0;c_cc=[]}t.Flags=r,t.Termios=class{constructor(){this.setDefaultShell()}get(){return this._flags}log(t){const i=(t,e,s)=>{const n=[];for(const[e,i]of Object.entries(t).filter(([t,e])=>t[0].match(/\D/)))(s&i)>0&&n.push(e);return`  ${e} = ${s} 0x${s.toString(16)} = ${n.join(" ")}`},r=["Cockle "+t+":"],o=this._flags;r.push(i(e,"c_iflag",o.c_iflag)),r.push(i(s,"c_oflag",o.c_oflag)),r.push(`  c_cflag = ${o.c_cflag} 0x${o.c_cflag.toString(16)}`),r.push(i(n,"c_lflag",o.c_lflag)),r.push(`  c_cc = ${o.c_cc}`),console.debug(r.join("\n"))}set(t){this._flags=t,this.log("Termios set")}setDefaultShell(){this.setDefaultWasm(),this._flags.c_oflag|=s.ONOCR}setDefaultWasm(){const t=this._flags;t.c_iflag=e.IUTF8|e.IMAXBEL|e.IXON|e.ICRNL,t.c_oflag=s.OPOST|s.ONLCR,t.c_cflag=191,t.c_lflag=n.IEXTEN|n.ECHOKE|n.ECHOCTL|n.ECHOK|n.ECHOE|n.ECHO|n.ICANON|n.ISIG,t.c_cc=[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}setRawMode(){const t=this._flags;t.c_iflag&=~(e.ISTRIP|e.INLCR|e.IGNCR|e.ICRNL|e.IXON),t.c_oflag&=~s.OPOST,t.c_lflag&=~(n.ECHO|n.ECHONL|n.ICANON|n.ISIG|n.IEXTEN)}_flags=new r}}(n||(n={}))},4207:(t,e,s)=>{s.d(e,{n:()=>r});var n=s(5670),i=s(952);class r extends n.j{flush(){}get input(){return new i.J(this)}}},5670:(t,e,s)=>{s.d(e,{j:()=>n});class n{get allContent(){return this.data.join("")}clear(){this.data=[]}isTerminal(){return!1}supportsAnsiEscapes(){return!1}write(t){this.data.push(t)}data=[]}},5874:(t,e,s)=>{s.d(e,{k:()=>a,s:()=>l});var n=s(2199),i=s(7095),r=s(585),o=s(955);class a{parse(t){return this._parseToRun(t.slice()),this}async tabComplete(t){const e={...t,args:t.args.slice()},s=await this._parseToTabComplete(e);return s.possibles&&(s.possibles=s.possibles.filter(e=>e.startsWith(t.args.at(-1)))),s}writeHelp(t){for(const e of this._help())t.write(`${e}\n`)}_findByLongName(t){const e=this._longNameArguments;if(t in e)return e[t];throw new i.$g(`No such longName argument '${t}'`)}_findByShortName(t){const e=this._shortNameArguments;if(t in e)return e[t];throw new i.$g(`No such shortName argument '${t}'`)}*_help(){this.description&&(yield this.description);const t=new r.XI({spacerSize:3});for(const e of Object.values(this))if(e instanceof n.ef){const{longName:s,shortName:n}=e;if(s||n){let i=n?`-${n}`:"  ";s&&(i+=(n?", ":"  ")+`--${s}`),t.addRow([i,e.description])}}if(t.rowCount>0&&(yield"",yield"options:",yield*t.lines("    ")),void 0!==this.subcommands){const t=new r.XI({spacerSize:3});for(const e of Object.values(this.subcommands))t.addRow([e.name,e.description]);t.rowCount>0&&(yield"",yield"subcommands:",yield*t.lines("    "))}}get _longNameArguments(){const t=Object.values(this).filter(t=>t instanceof n.ef&&"longName"in t&&t.longName.length>0);return Object.fromEntries(t.map(t=>[t.longName,t]))}_parseToRun(t){const{positional:e}=this;let s=!1;const n=this.subcommands??{};let r=!0;for(;t.length>0;){const o=t.shift();if(r&&o in n){const e=n[o];e.set(),e.parse(t);break}if(o.startsWith("-")&&o.length>1){if(s)throw new i.$g("Cannot have named argument after positional arguments");if(o.startsWith("--")){const e=o.slice(2);t=this._findByLongName(e).parse(o,t)}else for(const e of o.slice(1).split(""))t=this._findByShortName(e).parse(o,t)}else{if(void 0===e)throw new i.$g(`Unrecognised argument: '${o}'`);s=!0,t=e.parse(o,t)}r=!1}if(void 0!==e){const{min:t,max:s}=e.options;if(void 0!==t&&e.length<t)throw new i.$g("Insufficient positional arguments");if(void 0!==s&&e.length>s)throw new i.$g("Too many positional arguments")}}async _parseToTabComplete(t){let{args:e}=t;const{positional:s}=this,i=this.subcommands??{};let r=!0;for(;e.length>0;){const a=e.shift(),l=0===e.length;if(r&&i){if(l){const t=Object.keys(i).filter(t=>t.startsWith(a));if(t.length>0)return{possibles:t}}if(a in i){const e=i[a];return e.set(),await e.tabComplete(t)}}if(a.startsWith("-")){if(l){const t=Object.keys(this._longNameArguments).map(t=>"--"+t);return a.startsWith("--")?{possibles:t}:a.length>2?{}:{possibles:Object.keys(this._shortNameArguments).map(t=>"-"+t).concat(t)}}if(a.startsWith("--")){const t=a.slice(2);e=this._findByLongName(t).parse(a,e)}else for(const t of a.slice(1).split(""))e=this._findByShortName(t).parse(a,e)}else if(void 0!==s){if(s instanceof n.ET)return{pathType:s.options.pathType??o.y.Any};{const n=s.options.tabComplete;if(void 0!==n)return await n({...t,args:[a,...e]})}}r=!1}return{}}get _shortNameArguments(){const t=Object.values(this).filter(t=>t instanceof n.ef&&"shortName"in t&&t.shortName.length>0);return Object.fromEntries(t.map(t=>[t.shortName,t]))}positional;subcommands;description}class l extends a{name;description;constructor(t,e){super(),this.name=t,this.description=e}get isSet(){return this._isSet}set(){this._isSet=!0}_isSet=!1}},5981:(t,e,s)=>{s.d(e,{M:()=>i});var n=s(5670);class i extends n.j{fileSystem;path;append;constructor(t,e,s){super(),this.fileSystem=t,this.path=e,this.append=s}flush(){const{FS:t}=this.fileSystem;let e=this.allContent;if(this.append)try{e=t.readFile(this.path,{encoding:"utf8"})+e}catch(t){}t.writeFile(this.path,e,{mode:436}),this.clear()}}},7095:(t,e,s)=>{s.d(e,{$g:()=>a,C2:()=>o,Ge:()=>i,T6:()=>l,xZ:()=>r});var n=s(3482);class i extends Error{exitCode;constructor(t,e){super(e),this.exitCode=t}}class r extends i{constructor(t){super(n.y.CANNOT_FIND_COMMAND,`'${t}': command not found`)}}class o extends i{constructor(t){super(n.y.CANNOT_FIND_COMMAND,`'${t}': cannot load command`)}}class a extends i{constructor(t){super(n.y.GENERAL_ERROR,t)}}class l extends i{constructor(t){super(n.y.CANNOT_RUN_COMMAND,`'${t}': cannot run command`)}}},7450:(t,e,s)=>{s.d(e,{D:()=>n});class n extends Map{constructor(){super()}getRecursive(t){let e=this.get(t);for(;void 0!==e;){const s=e.split(" ")[0];if(s===t)break;const n=this.get(s);if(void 0===n)return e;e=n+e.slice(s.length),t=s}return e}match(t){return[...this.keys()].filter(e=>e.startsWith(t))}}},7497:(t,e,s)=>{s.d(e,{Ru:()=>l,Sv:()=>a,qg:()=>h});var n=s(7095),i=s(9685);const r=";&";class o{}class a extends o{name;suffix;redirects;constructor(t,e,s){super(),this.name=t,this.suffix=e,this.redirects=s}lastToken(){return this.redirects&&this.redirects.length>0?this.redirects[this.redirects.length-1].lastToken():this.suffix.length>0?[this.suffix[this.suffix.length-1],!1]:[this.name,!0]}}class l extends o{commands;constructor(t){super(),this.commands=t}lastToken(){return this.commands.length>0?this.commands[this.commands.length-1].lastToken():[null,!1]}}class c extends o{token;target;constructor(t,e){super(),this.token=t,this.target=e}lastToken(){return[this.target,!1]}}function h(t,e=!0,s){const n=(0,i.q)(t,e,s),o=[],a=[];let c=-1;const h=n.length;function d(){1===a.length?o.push(a[0]):a.length>1&&o.push(new l([...a])),a.length=0}for(let t=0;t<h;t++){const e=n[t];c>=0?r.includes(e.value)?(a.push(u(n.slice(c,t))),d(),c=-1):"|"===e.value&&(a.push(u(n.slice(c,t))),c=-1):r.includes(e.value)||(c=t)}return c>=0&&a.push(u(n.slice(c,h))),d(),o}function u(t){let e=t.slice(1);const s=e.findIndex(t=>{return(e=t.value).startsWith(">")||e.startsWith("<");var e});if(s>=0){if(e.length!==s+2)throw new n.$g("Redirect should be followed by file to redirect to");const i=new c(e[s],e[s+1]);return e=e.slice(0,s),new a(t[0],e,[i])}return new a(t[0],e)}},7703:(t,e,s)=>{s.d(e,{m:()=>n});class n{outputCallback;constructor(t,e,s){this.outputCallback=t,this.prefix=e,this.suffix=s}flush(){}isTerminal(){return!0}supportsAnsiEscapes(){return!0}write(t){t.length<1||(void 0!==this.prefix&&(t=this.prefix+t),void 0!==this.suffix&&(t+=this.suffix),this.outputCallback(t))}prefix;suffix}},8301:(t,e,s)=>{s.d(e,{F:()=>r});var n,i=s(3291);!function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"}(n||(n={}));class r{browsingContextId;shellId;constructor(t,e,s){this.browsingContextId=e,this.shellId=s,this._url=(0,i.oq)(t,"api/stdin/terminal")}getStdin(t){try{const{xhr:e,msg:s}=this._prepareStdinRequest(t,n.SYNC);return e.send(s),this._processStdinReply(e.responseText)}catch(t){return console.error(`Failed to request stdin via service worker: ${t}`),""}}async getStdinAsync(t,e=!1){try{const{xhr:s,msg:i}=this._prepareStdinRequest(t,n.ASYNC,e),r=new Promise((t,e)=>{s.onload=()=>t(s.responseText),s.onerror=()=>e("XHR error")});return s.send(i),this._processStdinReply(await r)}catch(t){return console.error(`Failed to request stdin via service worker: ${t}`),""}}_prepareStdinRequest(t,e,s=!1){const i=new XMLHttpRequest;i.open("POST",this._url,e===n.ASYNC);const r={shellId:this.shellId,timeoutMs:t};return s&&(r.test=!0),{xhr:i,msg:JSON.stringify({browsingContextId:this.browsingContextId,data:r})}}_processStdinReply(t){const e=JSON.parse(t);if("error"in e)throw new Error(e.error);if(void 0!==e.text)return e.text??"";throw new Error(`Invalid stdin response: ${e}`)}_url}},8316:(t,e,s)=>{s.d(e,{d:()=>n});class n{stdinCallback;stdinAsyncCallback;constructor(t,e){this.stdinCallback=t,this.stdinAsyncCallback=e}isTerminal(){return!0}async readAsync(t){return await this.stdinAsyncCallback(t)}read(t){return this.stdinCallback(t)}}},9399:(t,e,s)=>{s.d(e,{Q:()=>r});const n="[";function i(t){return Math.min(Math.max(Math.round(t),0),255)}const r={enableAlternativeBuffer:"[?1049h",disableAlternativeBuffer:"[?1049l",cursorUp:(t=1)=>t>0?n+t+"A":"",cursorDown:(t=1)=>t>0?n+t+"B":"",cursorRight:(t=1)=>t>0?n+t+"C":"",cursorLeft:(t=1)=>t>0?n+t+"D":"",cursorHome:"[H",eraseScreen:"[2J",eraseSavedLines:"[3J",eraseEndLine:"[K",eraseStartLine:"[1K",styleRGB:(t,e,s,r=!0)=>`${n}${r?"38":"48"};2;${i(t)};${i(e)};${i(s)}m`,styleReset:"[1;0m",styleBoldRed:"[1;31m",styleBoldGreen:"[1;32m",styleBrightRed:"[0;91m",styleBrightGreen:"[0;92m",styleBrightYellow:"[0;93m",styleBrightBlue:"[0;94m",styleBrightPurple:"[0;95m",styleBrightCyan:"[0;96m",styleRed:"[0;31m",styleGreen:"[0;32m",styleYellow:"[0;33m",styleBlue:"[0;34m",stylePurple:"[0;35m",styleCyan:"[0;36m",showCursor:"[?25h",hideCursor:"[?25l"}},9685:(t,e,s)=>{s.d(e,{q:()=>r});var n,i=s(7095);function r(t,e=!0,s){const n=new o(t,e,s);return n.run(),n.tokens}!function(t){t[t.None=0]="None",t[t.Delimiter=1]="Delimiter",t[t.DoubleQuote=2]="DoubleQuote",t[t.SingleQuote=3]="SingleQuote",t[t.Whitespace=4]="Whitespace",t[t.Other=5]="Other"}(n||(n={}));class o{throwErrors;aliases;constructor(t,e,s){this.throwErrors=e,this.aliases=s,this._source=t,this._tokens=[]}run(){for(;this._index<=this._source.length;)this._next();if(this.throwErrors&&""!==this._endQuote)throw new i.$g("Tokenize error, expected end quote "+this._endQuote)}get tokens(){return this._tokens}_addToken(){const t=this._offset,e=this._value;if(void 0!==this.aliases&&t!==this._aliasOffset&&(0===this._tokens.length||";&|".includes(this._tokens.at(-1).value.at(-1)))){const s=this.aliases.getRecursive(e);if(void 0!==s){const i=e.length;return this._offset=-1,this._index=t-1,this._aliasOffset=t,this._source=this._source.slice(0,t)+s+this._source.slice(t+i),this._prevChar="",this._prevCharType=n.None,this._value="",this._endQuote="",!1}}return this._tokens.push({offset:t,value:e}),this._endQuote="",!0}_getCharType(t){return" ".includes(t)?n.Whitespace:";&|><".includes(t)?n.Delimiter:"'"===t?n.SingleQuote:'"'===t?n.DoubleQuote:n.Other}_endQuoteFromCharType(t){return t===n.DoubleQuote?'"':t===n.SingleQuote?"'":""}_next(){const t=++this._index,e=t<this._source.length?this._source[t]:" ";let s=this._getCharType(e);const i=this._endQuoteFromCharType(s);this._offset>=0?this._endQuote?e!==this._endQuote?this._value+=e:(this._endQuote="",s=n.Other):i?this._endQuote=i:s===n.Whitespace?this._addToken()&&(this._offset=-1):s!==this._prevCharType||s===n.Delimiter&&e!==this._prevChar?this._addToken()&&(this._offset=t,this._value=e):this._value+=e:s!==n.Whitespace&&(this._offset=t,this._endQuote=this._endQuoteFromCharType(s),this._value=""===this._endQuote?e:""),this._prevChar=e,this._prevCharType=s}_source;_tokens;_prevChar="";_prevCharType=n.None;_index=-1;_offset=-1;_aliasOffset=-1;_value="";_endQuote=""}}}]);